<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Colocation</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f7fafc;
            color: #2d3748;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 25px 30px;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            background-color: #edf2f7;
            padding: 10px 0;
            position: relative;
        }
        
        .nav-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            color: #2b6cb0;
            border-bottom: 3px solid #4299e1;
            font-weight: 600;
        }
        
        .nav-tab:hover:not(.active) {
            background-color: #e2e8f0;
            border-radius: 5px;
        }
        
        .section {
            display: none;
            padding: 25px 30px;
            animation: fadeIn 0.3s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background-color: #4299e1;
            color: white;
        }
        
        .btn-secondary {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        
        .btn-danger {
            background-color: #fc8181;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4299e1;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .person-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .person-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .person-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .payment-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-paid {
            background-color: #c6f6d5;
            color: #2f855a;
        }
        
        .status-unpaid {
            background-color: #fed7d7;
            color: #c53030;
        }
        
        .dette-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dette-input span {
            font-weight: 500;
            color: #4a5568;
        }
        
        .dette-input input {
            width: 80px;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
        }
        
        .people-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .person-item {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .person-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .person-name {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .history-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .history-header {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 15px 20px;
        }
        
        .history-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-date {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .history-details {
            padding: 15px 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #edf2f7;
        }
        
        .detail-label {
            color: #718096;
            font-weight: 500;
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        .task-group {
            margin-bottom: 25px;
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #edf2f7;
        }
        
        .group-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .group-configuration {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .group-config-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .group-members {
            margin-top: 15px;
        }
        
        .group-member {
            padding: 8px 0;
            border-bottom: 1px solid #edf2f7;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #cbd5e0;
        }
        
        .empty-state h3 {
            font-size: 1.3rem;
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #718096;
        }
        
        .sync-indicator {
            position: absolute;
            right: 20px;
            top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #48bb78;
        }
        
        .notification.error {
            background-color: #e53e3e;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            transition: color 0.2s;
        }
        
        .close:hover {
            color: #2d3748;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #edf2f7;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #edf2f7;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .footer-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .rent-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .rent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .rent-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .rent-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2b6cb0;
        }
        
        .rent-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .payment-list {
            margin-top: 15px;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #edf2f7;
        }
        
        .payment-person {
            font-weight: 500;
        }
        
        .payment-date {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .expense-list {
            margin-top: 15px;
        }
        
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #edf2f7;
        }
        
        .expense-details {
            flex: 1;
        }
        
        .expense-title {
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .expense-date {
            color: #718096;
            font-size: 0.85rem;
        }
        
        .expense-amount {
            font-weight: 600;
            margin: 0 15px;
            min-width: 80px;
            text-align: right;
        }
        
        .lock-screen {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .lock-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #4299e1;
        }
        
        .lock-form {
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .password-input {
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        @media (max-width: 768px) {
            .payment-grid, .people-list, .history-grid, .task-group {
                grid-template-columns: 1fr;
            }
            
            .group-configuration {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gestion de Colocation</h1>
            <p class="subtitle">Suivi des cotisations, t√¢ches m√©nag√®res et gestion du loyer</p>
            <div id="currentWeek" style="font-size: 1.1rem; color: #ebf4ff; margin-top: 15px;"></div>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('cotisations')">üí∞ Cotisations</button>
            <button class="nav-tab" onclick="showSection('personnes')">üë• Personnes</button>
            <button class="nav-tab" onclick="showSection('historique')">üìä Historique</button>
            <button class="nav-tab" onclick="showSection('taches')">üßπ T√¢ches</button>
            <button class="nav-tab" onclick="showSection('depenses')">üè† Loyer & D√©penses</button>
            <div class="sync-indicator">
                <span id="syncStatus">Synchronisation</span>
                <span>üîÑ</span>
            </div>
        </div>
        
        <!-- Section Cotisations -->
        <div id="cotisations" class="section active">
            <div class="form-group">
                <label for="montantCotisation">Montant de la cotisation hebdomadaire (DH)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="number" id="montantCotisation" class="form-input" min="1" value="100">
                    <button class="btn btn-primary" onclick="changerMontantCotisation()">Modifier</button>
                </div>
                <small style="color: #718096; margin-top: 5px; display: block;">Actuellement: <span id="montantCotisationDisplay">100</span> DH par personne</small>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total personnes</div>
                    <div class="stat-value" id="totalPersonnes">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Cotisations pay√©es</div>
                    <div class="stat-value" id="totalPaye">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Dettes totales (DH)</div>
                    <div class="stat-value" id="totalDettes">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total collect√© (DH)</div>
                    <div class="stat-value" id="totalCollecte">0</div>
                </div>
            </div>
            
            <div id="paymentGrid" class="payment-grid">
                <!-- Les cartes de paiement seront g√©n√©r√©es ici -->
            </div>
        </div>
        
        <!-- Section Personnes -->
        <div id="personnes" class="section">
            <div class="form-group">
                <label for="personName">Ajouter une personne</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="personName" class="form-input" placeholder="Nom de la personne">
                    <button class="btn btn-primary" onclick="addPerson()">Ajouter</button>
                </div>
            </div>
            
            <div id="peopleList" class="people-list">
                <!-- La liste des personnes sera g√©n√©r√©e ici -->
            </div>
        </div>
        
        <!-- Section Historique -->
        <div id="historique" class="section">
            <h2 style="color: #2d3748; margin-bottom: 20px;">Historique des semaines</h2>
            
            <div id="historyGrid" class="history-grid">
                <!-- L'historique des semaines sera g√©n√©r√© ici -->
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-primary" onclick="sauvegarderManuellement()">üìÖ Sauvegarder la semaine manuellement</button>
                <small style="display: block; margin-top: 10px; color: #718096;">La sauvegarde automatique se fait chaque samedi √† 23h59</small>
            </div>
        </div>
        
        <!-- Section T√¢ches -->
        <div id="taches" class="section">
            <div>
                <h2 style="color: #2d3748; margin-bottom: 15px;">üõí Configuration des groupes</h2>
                <small style="color: #718096; display: block; margin-bottom: 20px;">
                    Configurez les groupes pour les courses et le m√©nage. Les groupes seront automatiquement rotatifs chaque semaine.
                </small>
                
                <div class="group-configuration" id="groupConfigContainer">
                    <!-- Configuration des groupes sera g√©n√©r√©e ici -->
                </div>
                
                <div class="footer-buttons">
                    <button class="btn btn-secondary" onclick="openGroupModal('courses')">Modifier les groupes de courses</button>
                    <button class="btn btn-secondary" onclick="openGroupModal('menage')">Modifier les groupes de m√©nage</button>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h2 style="color: #2d3748; margin-bottom: 15px;">T√¢ches de la semaine</h2>
                <small style="color: #718096; display: block; margin-bottom: 20px;">
                    Voici les t√¢ches assign√©es pour cette semaine.
                </small>
                
                <div id="tachesSemaineContainer">
                    <!-- T√¢ches de la semaine seront g√©n√©r√©es ici -->
                </div>
            </div>
        </div>
        
        <!-- Section Loyer & D√©penses -->
        <div id="depenses" class="section">
            <div id="rentLockScreen" class="lock-screen">
                <div class="lock-icon">üîí</div>
                <h2 style="margin-bottom: 15px; color: #2d3748;">Acc√®s s√©curis√©</h2>
                <p style="margin-bottom: 20px; color: #4a5568;">
                    Veuillez entrer le mot de passe pour acc√©der √† la gestion des loyers et d√©penses
                </p>
                <div class="lock-form">
                    <input type="password" id="rentPassword" class="password-input" placeholder="Mot de passe"
                        onkeypress="if (event.key === 'Enter') checkRentPassword()">
                    <button class="btn btn-primary" onclick="checkRentPassword()">Acc√©der</button>
                </div>
            </div>
            
            <div id="rentContent" class="rent-content" style="display: none;">
                <!-- Informations sur le loyer -->
                <div class="rent-section">
                    <div class="rent-header">
                        <div>
                            <div class="rent-title">üè† Loyer mensuel</div>
                            <small style="color: #718096;">Gestion des paiements du loyer</small>
                        </div>
                        <div class="rent-amount" id="totalLoyer">3000 DH</div>
                    </div>
                    
                    <div class="payment-list" id="rentPeopleList">
                        <!-- Liste des paiements sera g√©n√©r√©e ici -->
                    </div>
                    
                    <div class="rent-actions">
                        <button class="btn btn-secondary" onclick="openRentConfigModal()">Configurer</button>
                        <button class="btn btn-primary" onclick="openRentPaymentModal()">+ Ajouter un paiement</button>
                    </div>
                </div>
                
                <!-- D√©penses impr√©vues -->
                <div class="rent-section">
                    <div class="rent-header">
                        <div>
                            <div class="rent-title">üí∏ D√©penses impr√©vues</div>
                            <small style="color: #718096;">Frais suppl√©mentaires √† partager</small>
                        </div>
                        <div class="rent-amount" id="totalDepensesImprevues">0 DH</div>
                    </div>
                    
                    <div class="expense-list" id="expensesList">
                        <!-- Liste des d√©penses sera g√©n√©r√©e ici -->
                    </div>
                    
                    <div class="rent-actions">
                        <button class="btn btn-primary" onclick="openExpenseModal()">+ Ajouter une d√©pense</button>
                    </div>
                </div>
                
                <!-- R√©sum√© des paiements -->
                <div class="rent-section">
                    <div class="rent-header">
                        <div>
                            <div class="rent-title">üìä R√©sum√© des paiements</div>
                            <small style="color: #718096;">Solde de chaque personne</small>
                        </div>
                    </div>
                    
                    <div id="paymentSummary">
                        <!-- R√©sum√© des paiements sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de configuration des groupes -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGroupModal()">&times;</span>
            <div class="modal-header">
                <h2 id="groupModalTitle">Configurer les groupes de courses</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre de groupes</label>
                    <input type="number" id="numGroups" class="form-input" min="1" max="5" value="3">
                </div>
                
                <div id="groupsContainer">
                    <!-- Les groupes seront g√©n√©r√©s ici -->
                </div>
                
                <div class="form-group">
                    <label>T√¢ches √† accomplir</label>
                    <div id="tasksContainer">
                        <!-- Les t√¢ches seront g√©n√©r√©es ici -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addTaskField()" style="margin-top: 10px;">+ Ajouter une t√¢che</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGroupModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveGroupConfig()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de configuration du mot de passe -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePasswordModal()">&times;</span>
            <div class="modal-header">
                <h2>Configurer le mot de passe</h2>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-top: 20px;">
                    <label for="rentNewPassword">Nouveau mot de passe</label>
                    <input type="password" id="rentNewPassword" class="form-input" placeholder="Minimum 4 caract√®res">
                </div>
                <div class="form-group">
                    <label for="rentConfirmPassword">Confirmer le mot de passe</label>
                    <input type="password" id="rentConfirmPassword" class="form-input" placeholder="Confirmez le mot de passe">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePasswordModal()">Annuler</button>
                <button class="btn btn-primary" onclick="setRentPassword()">Configurer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de configuration du loyer -->
    <div id="rentConfigModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRentConfigModal()">&times;</span>
            <div class="modal-header">
                <h2>Configurer le loyer</h2>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-top: 20px;">
                    <label for="rentAmountConfig">Montant total du loyer (DH)</label>
                    <input type="number" id="rentAmountConfig" class="form-input" min="1" value="3000">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRentConfigModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveRentConfig()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de paiement du loyer -->
    <div id="rentPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRentPaymentModal()">&times;</span>
            <div class="modal-header">
                <h2>Enregistrer un paiement de loyer</h2>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-top: 20px;">
                    <label for="rentPerson">Personne</label>
                    <select id="rentPerson" class="form-input">
                        <!-- Liste des membres disponibles -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="rentAmount">Montant (DH)</label>
                    <input type="number" id="rentAmount" class="form-input" min="1" value="500">
                </div>
                <div class="form-group">
                    <label for="rentDate">Date</label>
                    <input type="date" id="rentDate" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRentPaymentModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveRentPayment()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal d'ajout de d√©pense -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeExpenseModal()">&times;</span>
            <div class="modal-header">
                <h2>Ajouter une d√©pense impr√©vue</h2>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-top: 20px;">
                    <label for="expenseName">Description</label>
                    <input type="text" id="expenseName" class="form-input" placeholder="Ex: Facture d'√©lectricit√©">
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Montant (DH)</label>
                    <input type="number" id="expenseAmount" class="form-input" min="1" value="100">
                </div>
                <div class="form-group">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeExpenseModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveExpense()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // Variables globales
        let personnes = [];
        let cotisationsSemaine = {};
        let historique = [];
        let montantCotisation = 100;
        let groupesConfig = {
            courses: {
                groupes: [[], [], []],
                noms: ['Groupe A', 'Groupe B', 'Groupe C'],
                taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
            },
            menage: {
                groupes: [[], []],
                noms: ['Groupe 1', 'Groupe 2'],
                taches: ['Fait le m√©nage', 'Se repose']
            }
        };
        let tachesHistorique = [];
        let loyerData = {
            total: 3000, // Montant total du loyer (modifiable)
            paiements: [],
            depensesImprevues: []
        };
        let isFirebaseSyncing = false;
        let lastSyncTime = 0;
        let rentPasswordSet = false;
        let rentPassword = '';
        let isRentAuthenticated = false;
        let roomCode = 'colocation'; // Code fixe pour tous les utilisateurs
        let currentGroupType = 'courses'; // Pour la modal de configuration

        // Fonction utilitaire pour s'assurer que la configuration des groupes est valide
        function ensureGroupConfigValid() {
            // V√©rifier et r√©parer les donn√©es courses
            if (!groupesConfig.courses || typeof groupesConfig.courses !== 'object') {
                groupesConfig.courses = {
                    groupes: [[], [], []],
                    noms: ['Groupe A', 'Groupe B', 'Groupe C'],
                    taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
                };
            }
            if (!Array.isArray(groupesConfig.courses.groupes)) {
                groupesConfig.courses.groupes = [[], [], []];
            }
            if (!Array.isArray(groupesConfig.courses.noms)) {
                groupesConfig.courses.noms = ['Groupe A', 'Groupe B', 'Groupe C'];
            }
            if (!Array.isArray(groupesConfig.courses.taches)) {
                groupesConfig.courses.taches = ['Ach√®te le poulet', 'Fait les courses', 'Se repose'];
            }

            // V√©rifier et r√©parer les donn√©es menage
            if (!groupesConfig.menage || typeof groupesConfig.menage !== 'object') {
                groupesConfig.menage = {
                    groupes: [[], []],
                    noms: ['Groupe 1', 'Groupe 2'],
                    taches: ['Fait le m√©nage', 'Se repose']
                };
            }
            if (!Array.isArray(groupesConfig.menage.groupes)) {
                groupesConfig.menage.groupes = [[], []];
            }
            if (!Array.isArray(groupesConfig.menage.noms)) {
                groupesConfig.menage.noms = ['Groupe 1', 'Groupe 2'];
            }
            if (!Array.isArray(groupesConfig.menage.taches)) {
                groupesConfig.menage.taches = ['Fait le m√©nage', 'Se repose'];
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // G√©n√©rer un ID utilisateur unique s'il n'existe pas
            if (!localStorage.getItem('userId')) {
                localStorage.setItem('userId', Date.now().toString());
            }
            chargerDonnees();
            
            // Mise √† jour de l'affichage du montant
            document.getElementById('montantCotisation').value = montantCotisation;
            document.getElementById('montantCotisationDisplay').textContent = montantCotisation;
            
            // Initialiser la date aujourd'hui pour les champs de date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rentDate').value = today;
            document.getElementById('expenseDate').value = today;
            
            // D√©marrer la v√©rification pour la sauvegarde automatique
            startAutoSaveCheck();
        });

        // CORRECTION PRINCIPALE - Ajout de la fonctionnalit√© de sauvegarde automatique
        // V√©rifier chaque minute si c'est le moment de sauvegarder automatiquement
        function startAutoSaveCheck() {
            // V√©rifier imm√©diatement au chargement
            checkAutoSave();
            
            // V√©rifier toutes les minutes
            setInterval(checkAutoSave, 60000);
        }

        // Fonction pour v√©rifier si c'est le moment de sauvegarder automatiquement
        function checkAutoSave() {
            const maintenant = new Date();
            const jour = maintenant.getDay(); // 0 = dimanche, 6 = samedi
            const heure = maintenant.getHours();
            const minutes = maintenant.getMinutes();
            
            // V√©rifier si c'est samedi (6) √† 23h59
            if (jour === 6 && heure === 23 && minutes === 59) {
                sauvegarderAutomatiquement();
            }
        }

        // Sauvegarde automatique de la semaine
        function sauvegarderAutomatiquement() {
            if (personnes.length === 0) {
                console.log('Aucune personne √† sauvegarder.');
                return;
            }
            
            const maintenant = new Date();
            const { dimanche } = mettreAJourSemaine();
            const vendredi = new Date(dimanche);
            vendredi.setDate(dimanche.getDate() + 5);
            
            const donneesSemaine = {
                id: `semaine_${dimanche.getTime()}_auto`,
                dateDebut: dimanche.toISOString(),
                dateFin: vendredi.toISOString(),
                personnes: [...personnes],
                cotisations: {...cotisationsSemaine},
                montantCotisation: montantCotisation,
                dateSauvegarde: maintenant.toISOString(),
                automatique: true
            };
            
            historique.unshift(donneesSemaine);
            // Garder seulement les 5 derni√®res semaines
            if (historique.length > 5) {
                historique = historique.slice(0, 5);
            }
            
            sauvegarderDonnees();
            rendreHistorique();
            afficherNotification('‚úÖ Semaine sauvegard√©e automatiquement !');
        }

        // Mise √† jour de la semaine actuelle
        function mettreAJourSemaine() {
            const maintenant = new Date();
            const jour = maintenant.getDay(); // 0 = dimanche, 6 = samedi
            const dimanche = new Date(maintenant);
            // Calculer le dimanche de la semaine en cours
            dimanche.setDate(maintenant.getDate() - (jour === 0 ? 0 : jour));
            dimanche.setHours(0, 0, 0, 0);
            
            // Mettre √† jour l'affichage
            document.getElementById('currentWeek').textContent = 
                `Semaine du ${dimanche.toLocaleDateString('fr-FR')} au ${new Date(dimanche.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString('fr-FR')}`;
            return { dimanche, maintenant };
        }

        // Sauvegarde manuelle de la semaine
        function sauvegarderManuellement() {
            if (personnes.length === 0) {
                afficherNotification('Aucune personne √† sauvegarder.', 'error');
                return;
            }
            
            const maintenant = new Date();
            const { dimanche } = mettreAJourSemaine();
            const vendredi = new Date(dimanche);
            vendredi.setDate(dimanche.getDate() + 5);
            
            const donneesSemaine = {
                id: `semaine_${dimanche.getTime()}_manuel`,
                dateDebut: dimanche.toISOString(),
                dateFin: vendredi.toISOString(),
                personnes: [...personnes],
                cotisations: {...cotisationsSemaine},
                montantCotisation: montantCotisation,
                dateSauvegarde: maintenant.toISOString(),
                automatique: false
            };
            
            historique.unshift(donneesSemaine);
            // Garder seulement les 5 derni√®res semaines
            if (historique.length > 5) {
                historique = historique.slice(0, 5);
            }
            
            sauvegarderDonnees();
            rendreHistorique();
            afficherNotification('‚úÖ Semaine sauvegard√©e manuellement !');
        }

        // Ajouter une personne
        function addPerson() {
            const input = document.getElementById('personName');
            const nom = input.value.trim();
            
            if (nom === '') {
                afficherNotification('Veuillez entrer un nom.', 'error');
                return;
            }
            
            const maintenant = new Date();
            const id = Date.now().toString();
            
            personnes.push({
                id: id,
                nom: nom,
                dateAjout: maintenant.toISOString()
            });
            
            // Initialiser les cotisations pour la nouvelle personne
            cotisationsSemaine[id] = { paye: false, dette: 0 };
            
            sauvegarderDonnees();
            rendrePersonnes();
            rendreCotisations();
            
            input.value = '';
            afficherNotification(`${nom} ajout√© avec succ√®s !`);
        }

        // Supprimer une personne
        function supprimerPersonne(idPersonne) {
            const personne = personnes.find(p => p.id === idPersonne);
            if (!personne) return;
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${personne.nom} ?`)) {
                personnes = personnes.filter(p => p.id !== idPersonne);
                delete cotisationsSemaine[idPersonne];
                
                // Retirer la personne des groupes avec v√©rifications de s√©curit√©
                Object.keys(groupesConfig).forEach(type => {
                    // V√©rifier que le type existe et que groupes est un tableau
                    if (groupesConfig[type] && Array.isArray(groupesConfig[type].groupes)) {
                        groupesConfig[type].groupes.forEach((groupe, index) => {
                            // V√©rifier que groupe est un tableau
                            if (Array.isArray(groupe)) {
                                const idx = groupe.indexOf(idPersonne);
                                if (idx !== -1) {
                                    groupe.splice(idx, 1);
                                }
                            } else {
                                // R√©initialiser le groupe s'il n'est pas un tableau
                                groupesConfig[type].groupes[index] = [];
                            }
                        });
                    }
                });
                
                sauvegarderDonnees();
                rendrePersonnes();
                rendreCotisations();
                rendreTaches();
                mettreAJourLoyer();
                afficherNotification(`${personne.nom} supprim√©.`);
            }
        }

        // Toggle paiement
        function togglePaiement(idPersonne) {
            if (cotisationsSemaine[idPersonne]) {
                cotisationsSemaine[idPersonne].paye = !cotisationsSemaine[idPersonne].paye;
                sauvegarderDonnees();
                rendreCotisations();
            }
        }

        // Mettre √† jour la dette
        function mettreAJourDette(idPersonne, montant) {
            const dette = parseFloat(montant) || 0;
            if (cotisationsSemaine[idPersonne]) {
                cotisationsSemaine[idPersonne].dette = dette;
                sauvegarderDonnees();
                rendreCotisations();
            }
        }

        // Changer le montant de la cotisation
        function changerMontantCotisation() {
            const input = document.getElementById('montantCotisation');
            const nouveauMontant = parseInt(input.value);
            
            if (isNaN(nouveauMontant) || nouveauMontant <= 0) {
                afficherNotification('Veuillez entrer un montant valide.', 'error');
                return;
            }
            
            const ancienMontant = montantCotisation;
            montantCotisation = nouveauMontant;
            
            sauvegarderDonnees();
            rendreCotisations();
            
            // Mettre √† jour l'affichage
            document.getElementById('montantCotisationDisplay').textContent = montantCotisation;
            afficherNotification(`Montant de la cotisation modifi√© de ${ancienMontant} DH √† ${montantCotisation} DH !`);
        }

        // Rendu des cotisations
        function rendreCotisations() {
            const grid = document.getElementById('paymentGrid');
            if (personnes.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <h3>Aucune personne ajout√©e</h3>
                        <p>Ajoutez des membres dans la section "Personnes" pour commencer.</p>
                    </div>`;
                mettreAJourStatistiques();
                return;
            }
            
            grid.innerHTML = personnes.map(personne => {
                const cotisation = cotisationsSemaine[personne.id] || { paye: false, dette: 0 };
                return `
                    <div class="person-card">
                        <div class="person-name">${personne.nom}</div>
                        <div class="payment-status">
                            <button class="btn ${cotisation.paye ? 'btn-secondary' : 'btn-primary'}" 
                                onclick="togglePaiement('${personne.id}')">
                                ${cotisation.paye ? 'Marquer non pay√©' : 'Marquer pay√©'}
                            </button>
                            <span class="status ${cotisation.paye ? 'status-paid' : 'status-unpaid'}">
                                ${cotisation.paye ? 'Pay√©' : 'Non pay√©'}
                            </span>
                        </div>
                        <div class="dette-input">
                            <span>Dette (DH):</span>
                            <input type="number" min="0" value="${cotisation.dette || 0}" 
                                onchange="mettreAJourDette('${personne.id}', this.value)">
                        </div>
                    </div>`;
            }).join('');
            
            mettreAJourStatistiques();
        }

        // Mise √† jour des statistiques
        function mettreAJourStatistiques() {
            const total = personnes.length;
            const payes = Object.values(cotisationsSemaine).filter(c => c.paye).length;
            const totalDettes = Object.values(cotisationsSemaine).reduce((sum, c) => sum + (c.paye ? c.dette : 0), 0);
            const totalCollecte = (payes * montantCotisation) - totalDettes;
            
            document.getElementById('totalPersonnes').textContent = total;
            document.getElementById('totalPaye').textContent = payes;
            document.getElementById('totalDettes').textContent = totalDettes;
            document.getElementById('totalCollecte').textContent = totalCollecte;
        }

        // Rendu des personnes
        function rendrePersonnes() {
            const list = document.getElementById('peopleList');
            if (personnes.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë§</div>
                        <h3>Aucune personne ajout√©e</h3>
                        <p>Ajoutez des membres en utilisant le formulaire ci-dessus.</p>
                    </div>`;
                return;
            }
            
            list.innerHTML = personnes.map(personne => `
                <div class="person-item">
                    <div class="person-info">
                        <div>
                            <div class="person-name">${personne.nom}</div>
                            <small>Membre depuis le ${new Date(personne.dateAjout).toLocaleDateString('fr-FR')}</small>
                        </div>
                        <div>
                            <button class="btn btn-danger" onclick="supprimerPersonne('${personne.id}')">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        // Rendu des t√¢ches
        function rendreTaches() {
            // S'assurer que la configuration des groupes est valide
            ensureGroupConfigValid();
            
            // Rendre la configuration des groupes
            rendreConfigGroupes();
            
            // Rendre les t√¢ches de la semaine
            rendreTachesSemaine();
        }

        // Rendre la configuration des groupes
        function rendreConfigGroupes() {
            // S'assurer que la configuration des groupes est valide
            ensureGroupConfigValid();
            
            const container = document.getElementById('groupConfigContainer');
            container.innerHTML = `
                <div class="group-config-card">
                    <div class="group-header">
                        <h3 class="group-title">Courses</h3>
                    </div>
                    ${renderGroupDetails('courses')}
                </div>
                <div class="group-config-card">
                    <div class="group-header">
                        <h3 class="group-title">M√©nage</h3>
                    </div>
                    ${renderGroupDetails('menage')}
                </div>`;
        }

        // Rendre les d√©tails d'un groupe
        function renderGroupDetails(type) {
            const config = groupesConfig[type];
            let html = '';
            
            config.groupes.forEach((groupe, index) => {
                const personnesGroupe = groupe.map(id => {
                    const personne = personnes.find(p => p.id === id);
                    return personne ? personne.nom : 'Inconnu';
                });
                
                html += `
                <div style="margin-top: 15px;">
                    <h4 style="margin-bottom: 8px; color: #2d3748;">${config.noms[index] || `Groupe ${index + 1}`}</h4>
                    <div class="group-members">
                        ${personnesGroupe.length > 0 ? 
                            personnesGroupe.map(nom => `<div class="group-member">${nom}</div>`).join('') : 
                            '<div class="group-member" style="color: #718096;">Aucun membre</div>'}
                    </div>
                    ${config.taches[index] ? `<div style="margin-top: 10px; font-weight: 500; color: #2b6cb0;">${config.taches[index]}</div>` : ''}
                </div>`;
            });
            
            return html;
        }

        // Rendre les t√¢ches de la semaine
        function rendreTachesSemaine() {
            // S'assurer que la configuration des groupes est valide
            ensureGroupConfigValid();
            
            const container = document.getElementById('tachesSemaineContainer');
            let html = '';
            
            // Pour chaque type de t√¢che (courses, menage)
            ['courses', 'menage'].forEach(type => {
                const config = groupesConfig[type];
                html += `
                <div class="task-group">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">${type === 'courses' ? 'üõí Courses' : 'üßπ M√©nage'}</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 10px;">`;
                
                // Pour chaque groupe
                config.groupes.forEach((groupe, index) => {
                    const personnesGroupe = groupe.map(id => {
                        const personne = personnes.find(p => p.id === id);
                        return personne ? personne.nom : 'Inconnu';
                    });
                    
                    html += `
                    <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #edf2f7;">
                        <h4 style="margin-bottom: 10px; color: #2d3748;">${config.noms[index] || `Groupe ${index + 1}`}</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                            ${personnesGroupe.map(nom => `
                                <span style="background: #e2e8f0; padding: 5px 10px; border-radius: 20px;">${nom}</span>
                            `).join('')}
                        </div>
                        ${config.taches[index] ? `
                            <div style="font-weight: 600; color: #2b6cb0; padding: 8px; background: #ebf8ff; border-radius: 6px;">
                                ${config.taches[index]}
                            </div>
                        ` : ''}
                    </div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
        }

        // Ouvrir la modal de configuration des groupes
        function openGroupModal(type) {
            // S'assurer que la configuration des groupes est valide
            ensureGroupConfigValid();
            
            currentGroupType = type;
            document.getElementById('groupModalTitle').textContent = 
                `Configurer les groupes de ${type === 'courses' ? 'courses' : 'm√©nage'}`;
            
            // D√©terminer le nombre de semaines √©coul√©es pour afficher la rotation actuelle
            const maintenant = new Date();
            const dimanche = new Date(maintenant);
            dimanche.setDate(maintenant.getDate() - maintenant.getDay());
            dimanche.setHours(0, 0, 0, 0);
            
            // Calculer le nombre de semaines √©coul√©es depuis une date de r√©f√©rence
            const dateRef = new Date(2023, 0, 1); // 1er janvier 2023
            const diffWeeks = Math.floor((dimanche - dateRef) / (7 * 24 * 60 * 60 * 1000));
            
            // Pr√©-remplir avec le nombre actuel de groupes
            document.getElementById('numGroups').value = groupesConfig[type].groupes.length;
            
            // G√©n√©rer les champs pour les groupes
            generateGroupFields();
            
            // Afficher la modal
            document.getElementById('groupModal').style.display = 'flex';
        }

        // G√©n√©rer les champs pour les groupes
        function generateGroupFields() {
            const numGroups = parseInt(document.getElementById('numGroups').value);
            const groupsContainer = document.getElementById('groupsContainer');
            const tasksContainer = document.getElementById('tasksContainer');
            
            // G√©n√©rer les champs pour les noms de groupes
            let groupsHtml = '';
            for (let i = 0; i < numGroups; i++) {
                const nom = groupesConfig[currentGroupType].noms[i] || `Groupe ${String.fromCharCode(65 + i)}`;
                groupsHtml += `
                <div class="form-group" style="margin-top: 15px;">
                    <label for="groupName${i}">Nom du groupe ${i + 1}</label>
                    <input type="text" id="groupName${i}" class="form-input" value="${nom}">
                </div>`;
            }
            groupsContainer.innerHTML = groupsHtml;
            
            // G√©n√©rer les champs pour les t√¢ches
            let tasksHtml = '';
            for (let i = 0; i < numGroups; i++) {
                const tache = groupesConfig[currentGroupType].taches[i] || '';
                tasksHtml += `
                <div class="task-field" style="margin-top: 10px; display: flex; align-items: center;">
                    <input type="text" class="form-input" value="${tache}" 
                        placeholder="T√¢che pour le groupe ${i + 1}">
                    <button type="button" class="btn btn-danger" onclick="removeTaskField(this)" 
                        style="margin-left: 10px; padding: 5px 10px;">√ó</button>
                </div>`;
            }
            tasksContainer.innerHTML = tasksHtml;
        }

        // Ajouter un champ de t√¢che
        function addTaskField() {
            const tasksContainer = document.getElementById('tasksContainer');
            const numGroups = tasksContainer.children.length;
            tasksContainer.innerHTML += `
            <div class="task-field" style="margin-top: 10px; display: flex; align-items: center;">
                <input type="text" class="form-input" 
                    placeholder="T√¢che pour le groupe ${numGroups + 1}">
                <button type="button" class="btn btn-danger" onclick="removeTaskField(this)" 
                    style="margin-left: 10px; padding: 5px 10px;">√ó</button>
            </div>`;
        }

        // Supprimer un champ de t√¢che
        function removeTaskField(button) {
            if (document.querySelectorAll('.task-field').length > 1) {
                button.parentElement.remove();
            }
        }

        // Sauvegarder la configuration des groupes
        function saveGroupConfig() {
            const numGroups = parseInt(document.getElementById('numGroups').value);
            const noms = [];
            const taches = [];
            
            // R√©cup√©rer les noms des groupes
            for (let i = 0; i < numGroups; i++) {
                const nom = document.getElementById(`groupName${i}`).value.trim() || `Groupe ${String.fromCharCode(65 + i)}`;
                noms.push(nom);
            }
            
            // R√©cup√©rer les t√¢ches
            document.querySelectorAll('#tasksContainer .form-input').forEach(input => {
                taches.push(input.value.trim());
            });
            
            // Mettre √† jour la configuration
            groupesConfig[currentGroupType] = {
                groupes: Array(numGroups).fill().map(() => []),
                noms: noms,
                taches: taches
            };
            
            // R√©partir les personnes dans les groupes de mani√®re √©quitable
            repartirPersonnesGroupes();
            
            sauvegarderDonnees();
            rendreTaches();
            closeGroupModal();
            afficherNotification('Configuration des groupes enregistr√©e avec succ√®s !');
        }

        // R√©partir les personnes dans les groupes de mani√®re √©quitable
        function repartirPersonnesGroupes() {
            // M√©langer les personnes pour une r√©partition al√©atoire
            const shuffledPersons = [...personnes].sort(() => 0.5 - Math.random());
            
            // R√©initialiser les groupes
            groupesConfig[currentGroupType].groupes = Array(groupesConfig[currentGroupType].noms.length).fill().map(() => []);
            
            // R√©partir les personnes
            for (let i = 0; i < shuffledPersons.length; i++) {
                const groupeIndex = i % groupesConfig[currentGroupType].groupes.length;
                groupesConfig[currentGroupType].groupes[groupeIndex].push(shuffledPersons[i].id);
            }
        }

        // Fermer la modal de configuration des groupes
        function closeGroupModal() {
            document.getElementById('groupModal').style.display = 'none';
        }

        // === GESTION LOYER & DEPENSES ===
        // V√©rifier le mot de passe pour acc√©der √† la section loyer
        function checkRentPassword() {
            const passwordInput = document.getElementById('rentPassword');
            const password = passwordInput.value;
            
            if (password === rentPassword) {
                isRentAuthenticated = true;
                localStorage.setItem('rentAuthenticated', 'true');
                document.getElementById('rentLockScreen').style.display = 'none';
                document.getElementById('rentContent').style.display = 'block';
                mettreAJourLoyer();
                passwordInput.value = '';
                afficherNotification('Acc√®s autoris√© √† la gestion des loyers et d√©penses.');
            } else {
                afficherNotification('Mot de passe incorrect.', 'error');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // Configurer le mot de passe
        function setRentPassword() {
            const newPassword = document.getElementById('rentNewPassword').value;
            const confirmPassword = document.getElementById('rentConfirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                afficherNotification('Les mots de passe ne correspondent pas.', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                afficherNotification('Le mot de passe doit contenir au moins 4 caract√®res.', 'error');
                return;
            }
            
            // Mettre √† jour les variables locales
            rentPasswordSet = true;
            rentPassword = newPassword;
            
            sauvegarderDonnees();
            closePasswordModal();
            afficherNotification('Mot de passe configur√© avec succ√®s !');
        }

        // Ouvrir la modal de configuration du mot de passe
        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        // Fermer la modal de configuration du mot de passe
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('rentNewPassword').value = '';
            document.getElementById('rentConfirmPassword').value = '';
        }

        // Ouvrir la modal de configuration du loyer
        function openRentConfigModal() {
            document.getElementById('rentAmountConfig').value = loyerData.total;
            document.getElementById('rentConfigModal').style.display = 'flex';
        }

        // Fermer la modal de configuration du loyer
        function closeRentConfigModal() {
            document.getElementById('rentConfigModal').style.display = 'none';
        }

        // Sauvegarder la configuration du loyer
        function saveRentConfig() {
            const amount = parseFloat(document.getElementById('rentAmountConfig').value);
            
            if (isNaN(amount) || amount <= 0) {
                afficherNotification('Veuillez entrer un montant valide.', 'error');
                return;
            }
            
            loyerData.total = amount;
            sauvegarderDonnees();
            mettreAJourLoyer();
            closeRentConfigModal();
            afficherNotification('Configuration du loyer enregistr√©e avec succ√®s !');
        }

        // Ouvrir la modal de paiement du loyer
        function openRentPaymentModal() {
            // Remplir la liste des personnes
            const select = document.getElementById('rentPerson');
            select.innerHTML = '';
            
            personnes.forEach(personne => {
                const option = document.createElement('option');
                option.value = personne.id;
                option.textContent = personne.nom;
                select.appendChild(option);
            });
            
            // Afficher la modal
            document.getElementById('rentPaymentModal').style.display = 'flex';
        }

        // Fermer la modal de paiement du loyer
        function closeRentPaymentModal() {
            document.getElementById('rentPaymentModal').style.display = 'none';
        }

        // Enregistrer un paiement de loyer
        function saveRentPayment() {
            const personId = parseInt(document.getElementById('rentPerson').value);
            const amount = parseFloat(document.getElementById('rentAmount').value);
            const date = document.getElementById('rentDate').value;
            
            if (isNaN(amount) || amount <= 0) {
                afficherNotification('Veuillez entrer un montant valide.', 'error');
                return;
            }
            
            if (!date) {
                afficherNotification('Veuillez s√©lectionner une date.', 'error');
                return;
            }
            
            // Ajouter le paiement
            loyerData.paiements.push({
                id: Date.now(),
                personneId: personId,
                montant: amount,
                date: date
            });
            
            sauvegarderDonnees();
            closeRentPaymentModal();
            mettreAJourLoyer();
            afficherNotification('Paiement du loyer enregistr√© avec succ√®s !');
        }

        // Supprimer un paiement de loyer
        function deleteRentPayment(paymentId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce paiement ?')) {
                loyerData.paiements = loyerData.paiements.filter(p => p.id !== paymentId);
                sauvegarderDonnees();
                mettreAJourLoyer();
                afficherNotification('Paiement supprim√© avec succ√®s.');
            }
        }

        // Ouvrir la modal d'ajout de d√©pense
        function openExpenseModal() {
            document.getElementById('expenseModal').style.display = 'flex';
        }

        // Fermer la modal d'ajout de d√©pense
        function closeExpenseModal() {
            document.getElementById('expenseModal').style.display = 'none';
        }

        // Enregistrer une d√©pense
        function saveExpense() {
            const name = document.getElementById('expenseName').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            
            if (!name) {
                afficherNotification('Veuillez entrer une description.', 'error');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                afficherNotification('Veuillez entrer un montant valide.', 'error');
                return;
            }
            
            if (!date) {
                afficherNotification('Veuillez s√©lectionner une date.', 'error');
                return;
            }
            
            // Ajouter la d√©pense
            loyerData.depensesImprevues.push({
                id: Date.now(),
                nom: name,
                montant: amount,
                date: date
            });
            
            sauvegarderDonnees();
            closeExpenseModal();
            mettreAJourLoyer();
            afficherNotification('D√©pense impr√©vue enregistr√©e avec succ√®s !');
        }

        // Supprimer une d√©pense
        function deleteExpense(expenseId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense ?')) {
                loyerData.depensesImprevues = loyerData.depensesImprevues.filter(e => e.id !== expenseId);
                sauvegarderDonnees();
                mettreAJourLoyer();
                afficherNotification('D√©pense supprim√©e avec succ√®s.');
            }
        }

        // Mettre √† jour l'affichage du loyer
        function mettreAJourLoyer() {
            // Mettre √† jour le montant total du loyer
            document.getElementById('totalLoyer').textContent = `${loyerData.total} DH`;
            
            // Afficher les paiements du loyer
            const peopleList = document.getElementById('rentPeopleList');
            peopleList.innerHTML = '';
            
            personnes.forEach(personne => {
                // CORRECTION : V√©rifier si paiements existe et est un tableau
                const paiementsPersonne = Array.isArray(loyerData.paiements) ? 
                    loyerData.paiements.filter(p => p.personneId === personne.id) : [];
                
                let totalPaye = 0;
                paiementsPersonne.forEach(p => {
                    totalPaye += p.montant;
                });
                
                peopleList.innerHTML += `
                <div class="payment-item">
                    <div>
                        <div class="payment-person">${personne.nom}</div>
                        <div class="payment-amount" style="color: #2b6cb0; font-weight: 500;">${totalPaye} DH / ${loyerData.total} DH</div>
                    </div>
                    <div>
                        <div class="payment-date">${paiementsPersonne.length > 0 ? 
                            new Date(paiementsPersonne[paiementsPersonne.length - 1].date).toLocaleDateString('fr-FR') : 
                            'Aucun paiement'}</div>
                    </div>
                </div>`;
            });
            
            // Afficher les d√©penses impr√©vues
            const expensesList = document.getElementById('expensesList');
            expensesList.innerHTML = '';
            
            if (loyerData.depensesImprevues.length === 0) {
                expensesList.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #718096;">
                    <h3>Aucune d√©pense enregistr√©e</h3>
                    <p>Ajoutez des d√©penses impr√©vues pour suivre les co√ªts suppl√©mentaires.</p>
                </div>`;
            } else {
                loyerData.depensesImprevues.forEach(depense => {
                    expensesList.innerHTML += `
                    <div class="expense-item">
                        <div class="expense-details">
                            <div class="expense-title">${depense.nom}</div>
                            <div class="expense-date">${new Date(depense.date).toLocaleDateString('fr-FR')}</div>
                        </div>
                        <div class="expense-amount">${depense.montant} DH</div>
                        <div class="expense-actions">
                            <button class="btn btn-danger" onclick="deleteExpense(${depense.id})">Supprimer</button>
                        </div>
                    </div>`;
                });
            }
            
            // Mettre √† jour le r√©sum√© des paiements
            mettreAJourResumePaiements();
        }

        // Mettre √† jour le r√©sum√© des paiements
        function mettreAJourResumePaiements() {
            // Calculer les totaux - SEULEMENT LOYER ET DEPENSES
            // CORRECTION : V√©rifier si paiements existe et est un tableau
            const totalLoyerPaye = Array.isArray(loyerData.paiements) ? 
                loyerData.paiements.reduce((sum, p) => sum + p.montant, 0) : 0;
            
            // CORRECTION : V√©rifier si depensesImprevues existe et est un tableau
            const totalDepenses = Array.isArray(loyerData.depensesImprevues) ? 
                loyerData.depensesImprevues.reduce((sum, d) => sum + d.montant, 0) : 0;
            
            const personnesActives = personnes.length;
            const partParPersonne = personnesActives > 0 ? 
                Math.round((loyerData.total + totalDepenses) / personnesActives) : 0;
            
            document.getElementById('totalDepensesImprevues').textContent = totalDepenses;
            document.getElementById('partParPersonne').textContent = partParPersonne;
            
            // Afficher le r√©sum√©
            const summary = document.getElementById('paymentSummary');
            summary.innerHTML = '';
            
            personnes.forEach(personne => {
                // Calculate how much this person paid for rent
                // CORRECTION : V√©rifier si paiements existe et est un tableau
                const loyerPaye = Array.isArray(loyerData.paiements) ? 
                    loyerData.paiements.filter(p => p.personneId === personne.id)
                    .reduce((sum, p) => sum + p.montant, 0) : 0;
                
                // Calculate the person's share of expenses
                const solde = loyerPaye - partParPersonne;
                
                const html = `
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px;">
                    <h4 style="margin-bottom: 10px; color: #2d3748;">${personne.nom}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div style="color: #718096; font-size: 0.9rem;">Pay√© pour le loyer</div>
                            <div style="font-weight: 600; color: #2b6cb0; font-size: 1.1rem;">${loyerPaye} DH</div>
                        </div>
                        <div>
                            <div style="color: #718096; font-size: 0.9rem;">Part √† payer</div>
                            <div style="font-weight: 600; color: #2d3748; font-size: 1.1rem;">${partParPersonne} DH</div>
                        </div>
                    </div>
                    <div style="padding: 10px; border-radius: 6px; background: ${solde >= 0 ? '#c6f6d5' : '#fed7d7'}; 
                        color: ${solde >= 0 ? '#2f855a' : '#c53030'}; font-weight: 600;">
                        Solde: ${solde >= 0 ? '+' : ''}${solde} DH
                    </div>
                </div>`;
                
                summary.innerHTML += html;
            });
        }

        // Mettre √† jour l'acc√®s √† la section loyer
        function mettreAJourRentAccess() {
            // V√©rifier si le mot de passe est configur√©
            if (rentPasswordSet) {
                // Si l'utilisateur est d√©j√† authentifi√©, on garde l'acc√®s
                if (isRentAuthenticated) {
                    document.getElementById('rentLockScreen').style.display = 'none';
                    document.getElementById('rentContent').style.display = 'block';
                } else {
                    // Sinon, on affiche l'√©cran de verrouillage
                    document.getElementById('rentLockScreen').style.display = 'block';
                    document.getElementById('rentContent').style.display = 'none';
                }
            } else {
                // Si pas de mot de passe configur√©, demander de le configurer
                document.getElementById('rentLockScreen').innerHTML = `
                    <div class="lock-icon">üîë</div>
                    <h2 style="margin-bottom: 15px; color: #2d3748;">Configurer le mot de passe</h2>
                    <p style="margin-bottom: 20px; color: #4a5568;">
                        Veuillez configurer un mot de passe pour s√©curiser l'acc√®s √† la gestion des loyers et d√©penses
                    </p>
                    <button class="btn btn-primary" onclick="openPasswordModal()">Configurer</button>`;
                document.getElementById('rentLockScreen').style.display = 'block';
                document.getElementById('rentContent').style.display = 'none';
            }
        }

        // Rendu de l'historique
        function rendreHistorique() {
            const grid = document.getElementById('historyGrid');
            
            if (historique.length === 0) {
                grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <h3>Aucune semaine sauvegard√©e</h3>
                    <p>Les semaines seront sauvegard√©es automatiquement chaque samedi √† 23h59.</p>
                </div>`;
                return;
            }
            
            grid.innerHTML = historique.map(semaine => {
                const dateDebut = new Date(semaine.dateDebut);
                const dateFin = new Date(semaine.dateFin);
                
                // Calculer le total des cotisations
                const totalCotisations = Object.values(semaine.cotisations).reduce((sum, c) => {
                    return sum + (c.paye ? semaine.montantCotisation : 0);
                }, 0);
                
                // Cr√©er la liste des personnes avec leur statut
                let personnesListe = '';
                semaine.personnes.forEach(personne => {
                    const cotisation = semaine.cotisations[personne.id] || { paye: false, dette: 0 };
                    personnesListe += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                        <div>
                            <span style="font-weight: 500;">${personne.nom}</span>
                            <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; 
                                background: ${cotisation.paye ? '#c6f6d5' : '#fed7d7'}; 
                                color: ${cotisation.paye ? '#2f855a' : '#c53030'};">
                                ${cotisation.paye ? 'Pay√©' : 'Non pay√©'}
                            </span>
                        </div>
                        ${cotisation.dette > 0 ? 
                            `<div style="font-weight: 600; color: #c53030;">${cotisation.dette} DH</div>` : ''}
                    </div>`;
                });
                
                return `
                <div class="history-card">
                    <div class="history-header">
                        <div class="history-title">Semaine du ${dateDebut.toLocaleDateString('fr-FR')}</div>
                        <div class="history-date">${dateDebut.toLocaleDateString('fr-FR')} - ${dateFin.toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div class="history-details">
                        <div class="detail-item">
                            <div class="detail-label">Personnes</div>
                            <div class="detail-value">${semaine.personnes.length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cotisation</div>
                            <div class="detail-value">${semaine.montantCotisation} DH</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cotisations pay√©es</div>
                            <div class="detail-value">${Object.values(semaine.cotisations).filter(c => c.paye).length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total collect√©</div>
                            <div class="detail-value">${totalCotisations} DH</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                        <h4 style="margin-bottom: 10px; color: #2d3748;">Statut des paiements</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${personnesListe}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Charger les donn√©es depuis le stockage local
        function chargerDonnees() {
            const donnees = localStorage.getItem('cotisationsData');
            if (donnees) {
                try {
                    const parsedData = JSON.parse(donnees);
                    
                    personnes = parsedData.personnes || [];
                    cotisationsSemaine = parsedData.cotisationsSemaine || {};
                    historique = parsedData.historique || [];
                    montantCotisation = parsedData.montantCotisation || 100;
                    
                    // Assurer une structure correcte pour groupesConfig
                    if (parsedData.groupesConfig) {
                        groupesConfig = {
                            courses: {
                                groupes: parsedData.groupesConfig.courses?.groupes || [[], [], []],
                                noms: parsedData.groupesConfig.courses?.noms || ['Groupe A', 'Groupe B', 'Groupe C'],
                                taches: parsedData.groupesConfig.courses?.taches || ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
                            },
                            menage: {
                                groupes: parsedData.groupesConfig.menage?.groupes || [[], []],
                                noms: parsedData.groupesConfig.menage?.noms || ['Groupe 1', 'Groupe 2'],
                                taches: parsedData.groupesConfig.menage?.taches || ['Fait le m√©nage', 'Se repose']
                            }
                        };
                    }
                    
                    loyerData = parsedData.loyerData || {
                        total: 3000,
                        paiements: [],
                        depensesImprevues: []
                    };
                    
                    // S'assurer que les propri√©t√©s de loyerData sont des tableaux
                    if (!Array.isArray(loyerData.paiements)) {
                        loyerData.paiements = [];
                    }
                    if (!Array.isArray(loyerData.depensesImprevues)) {
                        loyerData.depensesImprevues = [];
                    }
                    
                    rentPasswordSet = parsedData.rentPasswordSet || false;
                    rentPassword = parsedData.rentPassword || '';
                    
                    // V√©rifier si l'utilisateur est authentifi√© pour la section loyer
                    isRentAuthenticated = localStorage.getItem('rentAuthenticated') === 'true';
                    
                    // Mettre √† jour l'interface
                    mettreAJourSemaine();
                    rendreCotisations();
                    rendrePersonnes();
                    rendreHistorique();
                    rendreTaches();
                    
                    // Mettre √† jour l'affichage du montant
                    document.getElementById('montantCotisation').value = montantCotisation;
                    document.getElementById('montantCotisationDisplay').textContent = montantCotisation;
                    
                    // Mettre √† jour la section loyer
                    mettreAJourRentAccess();
                } catch (e) {
                    console.error("Erreur lors du chargement des donn√©es:", e);
                    resetDonnees();
                }
            } else {
                resetDonnees();
            }
        }

        // R√©initialiser les donn√©es
        function resetDonnees() {
            personnes = [];
            cotisationsSemaine = {};
            historique = [];
            montantCotisation = 100;
            groupesConfig = {
                courses: {
                    groupes: [[], [], []],
                    noms: ['Groupe A', 'Groupe B', 'Groupe C'],
                    taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
                },
                menage: {
                    groupes: [[], []],
                    noms: ['Groupe 1', 'Groupe 2'],
                    taches: ['Fait le m√©nage', 'Se repose']
                }
            };
            loyerData = {
                total: 3000,
                paiements: [],
                depensesImprevues: []
            };
            tachesHistorique = [];
            isRentAuthenticated = false;
            rentPasswordSet = false;
            
            // S'assurer que la configuration des groupes est valide
            ensureGroupConfigValid();
            
            // Mettre √† jour l'interface
            mettreAJourSemaine();
            rendreCotisations();
            rendrePersonnes();
            rendreHistorique();
            rendreTaches();
            
            // Mettre √† jour l'affichage du montant
            document.getElementById('montantCotisation').value = montantCotisation;
            document.getElementById('montantCotisationDisplay').textContent = montantCotisation;
            
            // Initialiser la date aujourd'hui pour les champs de date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rentDate').value = today;
            document.getElementById('expenseDate').value = today;
        }

        // Sauvegarde des donn√©es
        function sauvegarderDonnees() {
            const donnees = {
                personnes: personnes,
                cotisationsSemaine: cotisationsSemaine,
                historique: historique,
                montantCotisation: montantCotisation,
                groupesConfig: groupesConfig,
                loyerData: loyerData,
                tachesHistorique: tachesHistorique,
                rentPasswordSet: rentPasswordSet,
                rentPassword: rentPassword
            };
            
            localStorage.setItem('cotisationsData', JSON.stringify(donnees));
        }

        // Afficher une notification
        function afficherNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type === 'success' ? 'success' : 'error'} show`;
            
            setTimeout(() => {
                notification.className = notification.className.replace(' show', '');
            }, 3000);
        }

        // Gestion des sections
        function showSection(nomSection) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(nomSection).classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Si on acc√®de √† la section loyer, v√©rifier l'authentification
            if (nomSection === 'depenses') {
                mettreAJourRentAccess();
            }
        }

        // √âv√©nement pour Enter dans le champ nom
        document.addEventListener('keypress', function(e) {
            if (e.target.id === 'personName' && e.key === 'Enter') {
                addPerson();
            }
        });
    </script>
</body>
</html>
