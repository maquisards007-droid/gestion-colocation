<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>" type="image/svg+xml">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gestion de Colocation</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f7fafc;
      padding: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2d3748;
    }

    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      color: #2d3748;
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #4a5568;
      font-size: 1.1rem;
    }
    
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .nav-tab {
      padding: 12px 20px;
      background: #edf2f7;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      color: #4a5568;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
      text-align: center;
    }
    
    .nav-tab.active {
      background: #4299e1;
      color: white;
    }
    
    .section {
      display: none;
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .section.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2d3748;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
    }
    
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #4299e1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #3182ce;
    }
    
    .btn-secondary {
      background: #edf2f7;
      color: #4a5568;
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .btn-danger {
      background: #fc8181;
      color: white;
    }
    
    .btn-danger:hover {
      background: #f56565;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    
    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #2d3748;
      margin: 10px 0;
    }
    
    .stat-label {
      color: #718096;
      font-size: 1.1rem;
    }
    
    .payment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .person-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }
    
    .person-card:hover {
      transform: translateY(-3px);
    }
    
    .person-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 15px;
    }
    
    .payment-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }
    
    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .status-paid {
      background: #c6f6d5;
      color: #2f855a;
    }
    
    .status-unpaid {
      background: #fed7d7;
      color: #c53030;
    }
    
    .dette-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    
    .dette-input input {
      width: 80px;
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      text-align: center;
    }
    
    .people-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .person-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .person-info h3 {
      color: #2d3748;
      margin-bottom: 5px;
    }
    
    .person-info small {
      color: #718096;
      font-size: 0.85rem;
    }
    
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .history-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .history-title {
      font-weight: 600;
      color: #2d3748;
    }
    
    .history-date {
      color: #718096;
      font-size: 0.85rem;
    }
    
    .history-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .detail-item {
      padding: 10px;
      background: #f7fafc;
      border-radius: 8px;
    }
    
    .detail-label {
      font-size: 0.85rem;
      color: #718096;
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-weight: 600;
      color: #2d3748;
    }
    
    .task-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
      border-left: 4px solid #4299e1;
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .task-title {
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .task-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .group-item {
      background: #f7fafc;
      border-radius: 10px;
      padding: 15px;
      border-left: 4px solid #4299e1;
    }
    
    .group-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
    }
    
    .group-members {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .member-tag {
      background: #ebf4ff;
      color: #4299e1;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .remove-member {
      cursor: pointer;
      margin-left: 5px;
      color: #c53030;
    }
    
    .rent-section {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
    }
    
    .rent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .rent-title {
      font-size: 1.3rem;
      font-weight: 600;
    }
    
    .rent-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .summary-item {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .summary-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2d3748;
      margin: 10px 0;
    }
    
    .summary-label {
      color: #718096;
      font-size: 1.1rem;
    }
    
    .expenses-section {
      margin-top: 25px;
    }
    
    .expenses-form {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }
    
    .expense-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .expense-details {
      flex: 1;
    }
    
    .expense-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .expense-amount {
      color: #4299e1;
      font-weight: 600;
    }
    
    .expense-date {
      color: #718096;
      font-size: 0.85rem;
    }
    
    .expense-actions {
      display: flex;
      gap: 10px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      margin: auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #718096;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .notification.success {
      background: #48bb78;
    }
    
    .notification.error {
      background: #e53e3e;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.6;
    }
    
    .lock-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    
    .lock-icon {
      font-size: 3rem;
      margin-bottom: 20px;
    }
    
    .password-input {
      width: 100%;
      max-width: 300px;
      padding: 12px 15px;
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .rent-content {
      display: none;
    }
    
    .person-rent {
      background: #f7fafc;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .person-rent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .rent-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-paid {
      background: #c6f6d5;
      color: #2f855a;
    }
    
    .status-unpaid {
      background: #fed7d7;
      color: #c53030;
    }
    
    .group-configuration {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }
    
    .group-config {
      background: #f7fafc;
      border-radius: 10px;
      padding: 15px;
    }
    
    .group-config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .group-config-title {
      font-weight: 600;
      color: #2d3748;
    }
    
    .group-config-task {
      font-size: 0.9rem;
      color: #4299e1;
      margin-bottom: 15px;
      padding: 5px 10px;
      background: #ebf4ff;
      border-radius: 5px;
    }
    
    .members-list {
      min-height: 100px;
      border: 1px dashed #cbd5e0;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .instructions {
      background: #ebf8ff;
      border-left: 4px solid #4299e1;
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
      color: #2d3748;
    }
    
    .instructions h4 {
      margin-bottom: 10px;
      color: #2b6cb0;
    }
    
    .instructions ul {
      padding-left: 20px;
    }
    
    .instructions li {
      margin-bottom: 5px;
    }
    
    .footer-buttons {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 15px 0;
      margin-top: 15px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .drag-over {
      background-color: #ebf4ff;
      border-color: #4299e1;
    }
    
    .sync-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 10px;
      color: white;
      font-size: 0.8rem;
    }
    
    .sync-indicator span {
      font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
      .nav-tabs {
        flex-direction: column;
      }
      
      .nav-tab {
        width: 100%;
      }
      
      .payment-grid, .people-list, .history-grid, .task-group {
        grid-template-columns: 1fr;
      }
      
      .group-configuration {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        height: 90vh;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gestion de Colocation</h1>
      <p class="subtitle">Suivi des cotisations, t√¢ches m√©nag√®res et gestion du loyer</p>
      <div id="currentWeek" style="font-size: 1.1rem; color: #4a5568; margin-top: 15px;"></div>
    </header>
    
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('cotisations')">üí∞ Cotisations</button>
      <button class="nav-tab" onclick="showSection('personnes')">üë• Personnes</button>
      <button class="nav-tab" onclick="showSection('historique')">üìä Historique</button>
      <button class="nav-tab" onclick="showSection('taches')">üßπ T√¢ches</button>
      <button class="nav-tab" onclick="showSection('depenses')">üè† Loyer & D√©penses</button>
      <div class="sync-indicator">
        <span id="syncStatus">Synchronisation</span>
        <span>üîÑ</span>
      </div>
    </div>
    
    <!-- Section Cotisations -->
    <div id="cotisations" class="section active">
      <div class="form-group">
        <label for="montantCotisation">Montant de la cotisation hebdomadaire (DH)</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="number" id="montantCotisation" class="form-input" min="1" value="100">
          <button class="btn btn-primary" onclick="changerMontantCotisation()">Modifier</button>
        </div>
        <small style="color: #718096; margin-top: 5px; display: block;">Actuellement: <span id="montantCotisationDisplay">100</span> DH par personne</small>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total personnes</div>
          <div class="stat-value" id="totalPersonnes">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Cotisations pay√©es</div>
          <div class="stat-value" id="totalPaye">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Dettes totales (DH)</div>
          <div class="stat-value" id="totalDettes">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total collect√© (DH)</div>
          <div class="stat-value" id="totalCollecte">0</div>
        </div>
      </div>
      
      <div id="paymentGrid" class="payment-grid">
        <!-- Les cartes de paiement seront g√©n√©r√©es ici -->
      </div>
    </div>
    
    <!-- Section Personnes -->
    <div id="personnes" class="section">
      <div class="form-group">
        <label for="personName">Ajouter une personne</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="personName" class="form-input" placeholder="Nom de la personne">
          <button class="btn btn-primary" onclick="addPerson()">Ajouter</button>
        </div>
      </div>
      
      <div id="peopleList" class="people-list">
        <!-- La liste des personnes sera g√©n√©r√©e ici -->
      </div>
    </div>
    
    <!-- Section Historique -->
    <div id="historique" class="section">
      <div class="history-grid" id="historyGrid">
        <!-- L'historique des semaines sera g√©n√©r√© ici -->
      </div>
      
      <div style="margin-top: 30px; text-align: center;">
        <button class="btn btn-primary" onclick="sauvegarderManuellement()">
          üìÖ Sauvegarder la semaine manuellement
        </button>
        <small style="display: block; margin-top: 10px; color: #718096;">
          La sauvegarde automatique se fait chaque samedi √† 23h59
        </small>
      </div>
    </div>
    
    <!-- Section T√¢ches -->
    <div id="taches" class="section">
      <div>
        <h2 style="color: #2d3748; margin-bottom: 15px;">üõí Configuration des groupes</h2>
        <small style="color: #718096; display: block; margin-bottom: 20px;">
          D√©finissez vos groupes pour les t√¢ches m√©nag√®res
        </small>
      </div>
      
      <div>
        <h3 style="margin-bottom: 15px; color: #2d3748;">üõí Groupes pour les courses/poulet (3 groupes de 2)</h3>
        <div id="coursesGroupsConfig">
          <!-- Configuration des groupes pour les courses -->
        </div>
        <button class="btn btn-primary" style="margin-top: 15px;" onclick="openGroupModal('courses')">
          üõ†Ô∏è Configurer les groupes
        </button>
      </div>
      
      <div style="margin-top: 25px;">
        <h3 style="margin-bottom: 15px; color: #2d3748;">üßπ Groupes pour le m√©nage (2 groupes)</h3>
        <div id="menageGroupsConfig">
          <!-- Configuration des groupes pour le m√©nage -->
        </div>
        <button class="btn btn-primary" style="margin-top: 15px;" onclick="openGroupModal('menage')">
          üõ†Ô∏è Configurer les groupes
        </button>
      </div>
      
      <div id="currentTasks" style="margin-top: 30px;">
        <!-- Les t√¢ches de la semaine seront affich√©es ici -->
      </div>
    </div>
    
    <!-- Section Loyer & D√©penses (Priv√©e) -->
    <div id="depenses" class="section">
      <div id="rentLockScreen" class="lock-screen">
        <div class="lock-icon">üîí</div>
        <h2 style="margin-bottom: 15px; color: #2d3748;">Acc√®s r√©serv√©</h2>
        <p style="margin-bottom: 20px; color: #4a5568;">
          Veuillez entrer le mot de passe pour acc√©der √† la gestion des loyers et d√©penses
        </p>
        <div class="lock-form">
          <input type="password" id="rentPassword" class="password-input" placeholder="Mot de passe" 
                 onkeypress="if (event.key === 'Enter') checkRentPassword()">
          <button class="btn btn-primary" onclick="checkRentPassword()">Acc√©der</button>
        </div>
      </div>
      
      <div id="rentContent" class="rent-content">
        <!-- Informations sur le loyer -->
        <div class="rent-section">
          <div class="rent-header">
            <div>
              <div class="rent-title">üè† Loyer mensuel</div>
              <small style="color: #718096;">Gestion des paiements du loyer</small>
            </div>
            <div>
              <button class="btn btn-secondary" onclick="openRentConfigModal()">‚öôÔ∏è Configurer le loyer</button>
            </div>
          </div>
          
          <div class="rent-summary">
            <div class="summary-item">
              <div class="summary-label">Montant total</div>
              <div class="summary-value" id="totalLoyer">3000</div>
              <div style="font-size: 0.9rem; color: #718096;">DH</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Loyer pay√©</div>
              <div class="summary-value" id="loyerPaye">0</div>
              <div style="font-size: 0.9rem; color: #718096;">DH</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Reste √† payer</div>
              <div class="summary-value" id="loyerRestant">3000</div>
              <div style="font-size: 0.9rem; color: #718096;">DH</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Personnes concern√©es</div>
              <div class="summary-value" id="personnesLoyer">0</div>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="openRentPaymentModal()">+ Enregistrer un paiement</button>
          </div>
          
          <div id="rentPeopleList" style="margin-top: 25px;">
            <!-- Liste des paiements par personne -->
          </div>
        </div>
        
        <!-- Gestion des d√©penses impr√©vues -->
        <div class="expenses-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h2 style="color: #2d3748;">üßæ D√©penses impr√©vues du mois</h2>
              <small style="color: #718096;">Factures, r√©parations, gaz, etc.</small>
            </div>
            <button class="btn btn-primary" onclick="openExpenseModal()">+ Ajouter une d√©pense</button>
          </div>
          
          <div class="expenses-form">
            <div class="form-group">
              <div class="form-label">Total des d√©penses du mois</div>
              <div style="display: flex; align-items: center;">
                <div style="font-size: 2rem; font-weight: 700; color: #2d3748; margin-right: 5px;" id="totalDepensesImprevues">0</div>
                <div style="font-size: 1.2rem; color: #718096;">DH</div>
              </div>
            </div>
            
            <div class="form-group">
              <div class="form-label">Part par personne</div>
              <div style="display: flex; align-items: center;">
                <div style="font-size: 2rem; font-weight: 700; color: #2d3748; margin-right: 5px;" id="partParPersonne">0</div>
                <div style="font-size: 1.2rem; color: #718096;">DH</div>
              </div>
            </div>
          </div>
          
          <div id="expensesList">
            <!-- Liste des d√©penses -->
          </div>
        </div>
        
        <!-- R√©sum√© des paiements -->
        <div class="rent-section">
          <div class="rent-header">
            <div>
              <div class="rent-title">üìä R√©sum√© des paiements</div>
              <small style="color: #718096;">Synth√®se des paiements du mois</small>
            </div>
          </div>
          
          <div class="rent-summary" style="margin-bottom: 20px;">
            <div class="summary-item">
              <div class="summary-value" id="totalPayeMois">0</div>
              <div class="summary-label">Loyer pay√©</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="totalDepensesCalculees">0</div>
              <div class="summary-label">D√©penses impr√©vues</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="soldeGlobal">0</div>
              <div class="summary-label">Solde global</div>
            </div>
          </div>
          
          <div id="paymentSummaryList">
            <!-- R√©sum√© par personne -->
          </div>
          
          <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-primary" onclick="genererRapport()">G√©n√©rer le rapport</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal de configuration des groupes -->
    <div id="groupModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeGroupModal()">&times;</span>
        <h2 id="groupModalTitle"></h2>
        
        <div id="groupInstructions" class="instructions">
          <!-- Instructions sp√©cifiques selon le type de groupe -->
        </div>
        
        <div id="groupConfigContent"></div>
        
        <div id="groupConfiguration" class="group-configuration">
          <!-- Configuration des groupes avec explication des t√¢ches -->
        </div>
        
        <div id="groupMembersList" style="margin-top: 20px;">
          <h3 style="margin: 20px 0 15px; color: #2d3748;">Membres disponibles</h3>
          <div id="availableMembers" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
            <!-- Liste des membres disponibles -->
          </div>
        </div>
        
        <div class="footer-buttons">
          <button class="btn btn-secondary" onclick="closeGroupModal()">Annuler</button>
          <button class="btn btn-primary" onclick="saveGroupConfig()">Enregistrer</button>
        </div>
      </div>
    </div>
    
    <!-- Modal de configuration du mot de passe -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closePasswordModal()">&times;</span>
        <h2>Configurer le mot de passe</h2>
        <div class="form-group" style="margin-top: 20px;">
          <label for="rentNewPassword">Nouveau mot de passe</label>
          <input type="password" id="rentNewPassword" class="form-input" placeholder="Minimum 4 caract√®res">
        </div>
        <div class="form-group">
          <label for="rentConfirmPassword">Confirmer le mot de passe</label>
          <input type="password" id="rentConfirmPassword" class="form-input" placeholder="Confirmez le mot de passe">
        </div>
        <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
          <button class="btn btn-secondary" onclick="closePasswordModal()">Annuler</button>
          <button class="btn btn-primary" onclick="setRentPassword()">Configurer</button>
        </div>
      </div>
    </div>
    
    <!-- Modal de configuration du loyer -->
    <div id="rentConfigModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeRentConfigModal()">&times;</span>
        <h2>Configurer le montant du loyer</h2>
        <div class="form-group" style="margin-top: 20px;">
          <label for="rentAmountConfig">Montant du loyer (DH)</label>
          <input type="number" id="rentAmountConfig" class="form-input" min="1" value="3000">
        </div>
        <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeRentConfigModal()">Annuler</button>
          <button class="btn btn-primary" onclick="saveRentConfig()">Enregistrer</button>
        </div>
      </div>
    </div>
    
    <!-- Modal de paiement du loyer -->
    <div id="rentPaymentModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeRentPaymentModal()">&times;</span>
        <h2>Enregistrer un paiement de loyer</h2>
        <div class="form-group" style="margin-top: 20px;">
          <label for="rentPerson">Personne</label>
          <select id="rentPerson" class="form-input"></select>
        </div>
        <div class="form-group">
          <label for="rentAmount">Montant (DH)</label>
          <input type="number" id="rentAmount" class="form-input" min="1" value="500">
        </div>
        <div class="form-group">
          <label for="rentDate">Date du paiement</label>
          <input type="date" id="rentDate" class="form-input">
        </div>
        <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeRentPaymentModal()">Annuler</button>
          <button class="btn btn-primary" onclick="saveRentPayment()">Enregistrer</button>
        </div>
      </div>
    </div>
    
    <!-- Modal d'ajout de d√©pense -->
    <div id="expenseModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeExpenseModal()">&times;</span>
        <h2>Ajouter une d√©pense impr√©vue</h2>
        <div class="form-group" style="margin-top: 20px;">
          <label for="expenseName">Description</label>
          <input type="text" id="expenseName" class="form-input" placeholder="Ex: Facture d'√©lectricit√©">
        </div>
        <div class="form-group">
          <label for="expenseAmount">Montant (DH)</label>
          <input type="number" id="expenseAmount" class="form-input" min="1" value="100">
        </div>
        <div class="form-group">
          <label for="expenseDate">Date de la d√©pense</label>
          <input type="date" id="expenseDate" class="form-input">
        </div>
        <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeExpenseModal()">Annuler</button>
          <button class="btn btn-primary" onclick="saveExpense()">Enregistrer</button>
        </div>
      </div>
    </div>
    
    <!-- Modal de rapport -->
    <div id="reportModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="document.getElementById('reportModal').style.display = 'none'">&times;</span>
        <h2>Rapport de gestion</h2>
        <div id="reportContent" style="margin-top: 20px; line-height: 1.8;">
          <!-- Contenu du rapport -->
        </div>
        <div style="margin-top: 25px; display: flex; justify-content: flex-end;">
          <button class="btn btn-primary" onclick="printReport()">Imprimer</button>
        </div>
      </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    // Configuration Firebase - CORRIG√âE POUR LA R√âGION EUROPE
    const firebaseConfig = {
      apiKey: "AIzaSyB7S2I45eyDhskcZIsR_3wUXnakIE-IKOA",
      authDomain: "gestion-colocation-4e320.firebaseapp.com",
      databaseURL: "https://gestion-colocation-4e320-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gestion-colocation-4e320",
      storageBucket: "gestion-colocation-4e320.firebasestorage.app",
      messagingSenderId: "130270216760",
      appId: "1:130270216760:web:e466b6a6dd8cab8a215ccd",
      measurementId: "G-KQ42KHYL3H"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Variables globales
    let personnes = [];
    let cotisationsSemaine = {};
    let historique = [];
    let montantCotisation = 100;
    let groupesConfig = {
      courses: {
        groupes: [[], [], []],
        noms: ['Groupe A', 'Groupe B', 'Groupe C'],
        taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
      },
      menage: {
        groupes: [[], []],
        noms: ['Groupe 1', 'Groupe 2'],
        taches: ['Fait le m√©nage', 'Se repose']
      }
    };
    let tachesHistorique = [];
    let loyerData = {
      total: 3000, // Montant total du loyer (modifiable)
      paiements: [],
      depensesImprevues: []
    };
    let isFirebaseSyncing = false;
    let lastSyncTime = 0;
    let rentPasswordSet = false;
    let rentPassword = '';
    let isRentAuthenticated = false;
    let roomCode = 'colocation'; // Code fixe pour tous les utilisateurs

    // Fonction pour sauvegarder dans Firebase
    function sauvegarderSurFirebase() {
      // Ne pas synchroniser si on est en train de charger des donn√©es
      if (isFirebaseSyncing) return;
      
      const donnees = {
        personnes: personnes,
        cotisationsSemaine: cotisationsSemaine,
        montantCotisation: montantCotisation,
        groupesConfig: groupesConfig,
        loyerData: loyerData,
        timestamp: Date.now(),
        lastModifiedBy: localStorage.getItem('userId') || 'unknown',
        rentPasswordSet: rentPasswordSet,
        rentPassword: rentPassword
      };
      
      isFirebaseSyncing = true;
      database.ref('colocations/' + roomCode).set(donnees)
        .then(() => {
          console.log("Donn√©es synchronis√©es avec Firebase");
          lastSyncTime = Date.now();
          document.getElementById('syncStatus').textContent = '‚úì Synchronis√©';
          setTimeout(() => {
            document.getElementById('syncStatus').textContent = 'Synchronisation';
          }, 2000);
        })
        .catch(error => {
          console.error("Erreur de synchronisation:", error);
          document.getElementById('syncStatus').textContent = '‚úó Erreur';
          setTimeout(() => {
            document.getElementById('syncStatus').textContent = 'Synchronisation';
          }, 2000);
        })
        .finally(() => {
          isFirebaseSyncing = false;
        });
    }
    
        // Fonction pour charger depuis Firebase
    function chargerDepuisFirebase() {
      database.ref('colocations/' + roomCode).on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          // Mettre √† jour les donn√©es
          personnes = data.personnes || [];
          cotisationsSemaine = data.cotisationsSemaine || {};
          montantCotisation = data.montantCotisation || 100;
          
          // V√©rification RENFORC√âE pour groupesConfig
          if (data.groupesConfig) {
            // V√©rifier et r√©parer les donn√©es courses
            if (data.groupesConfig.courses) {
              groupesConfig.courses = {
                groupes: Array.isArray(data.groupesConfig.courses.groupes) ? 
                        data.groupesConfig.courses.groupes : [[], [], []],
                noms: Array.isArray(data.groupesConfig.courses.noms) ? 
                      data.groupesConfig.courses.noms : ['Groupe A', 'Groupe B', 'Groupe C'],
                taches: Array.isArray(data.groupesConfig.courses.taches) ? 
                        data.groupesConfig.courses.taches : ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
              };
            } else {
              groupesConfig.courses = {
                groupes: [[], [], []],
                noms: ['Groupe A', 'Groupe B', 'Groupe C'],
                taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
              };
            }
            
            // V√©rifier et r√©parer les donn√©es menage
            if (data.groupesConfig.menage) {
              groupesConfig.menage = {
                groupes: Array.isArray(data.groupesConfig.menage.groupes) ? 
                        data.groupesConfig.menage.groupes : [[], []],
                noms: Array.isArray(data.groupesConfig.menage.noms) ? 
                      data.groupesConfig.menage.noms : ['Groupe 1', 'Groupe 2'],
                taches: Array.isArray(data.groupesConfig.menage.taches) ? 
                        data.groupesConfig.menage.taches : ['Fait le m√©nage', 'Se repose']
              };
            } else {
              groupesConfig.menage = {
                groupes: [[], []],
                noms: ['Groupe 1', 'Groupe 2'],
                taches: ['Fait le m√©nage', 'Se repose']
              };
            }
          } else {
            // R√©initialiser compl√®tement si groupesConfig est manquant
            groupesConfig = {
              courses: {
                groupes: [[], [], []],
                noms: ['Groupe A', 'Groupe B', 'Groupe C'],
                taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
              },
              menage: {
                groupes: [[], []],
                noms: ['Groupe 1', 'Groupe 2'],
                taches: ['Fait le m√©nage', 'Se repose']
              }
            };
          }
          
          loyerData = data.loyerData || {
            total: 3000,
            paiements: [],
            depensesImprevues: []
          };
          
          rentPasswordSet = data.rentPasswordSet || false;
          rentPassword = data.rentPassword || '';
          
          // Mettre √† jour l'interface
          rendreCotisations();
          rendrePersonnes();
          rendreTaches();
          mettreAJourLoyer();
          mettreAJourRentAccess();
          
          // Afficher une notification seulement si ce n'est pas nous qui avons fait la modification
          if (data.lastModifiedBy !== localStorage.getItem('userId')) {
            // Pas de notification de synchronisation
          }
        }
      });
    }
    
    // Mettre √† jour l'acc√®s √† la section loyer
    function mettreAJourRentAccess() {
      // V√©rifier si le mot de passe est configur√©
      if (rentPasswordSet) {
        // Si l'utilisateur est d√©j√† authentifi√©, on garde l'acc√®s
        if (isRentAuthenticated) {
          document.getElementById('rentLockScreen').style.display = 'none';
          document.getElementById('rentContent').style.display = 'block';
        } else {
          // Sinon, on affiche l'√©cran de verrouillage
          document.getElementById('rentLockScreen').style.display = 'flex';
          document.getElementById('rentContent').style.display = 'none';
        }
      } else {
        // Si le mot de passe n'est pas configur√©, on affiche la modal de configuration
        if (!document.getElementById('passwordModal').style.display || document.getElementById('passwordModal').style.display === 'none') {
          openPasswordModal();
        }
      }
    }
    
    // Charger les donn√©es
    function chargerDonnees() {
      const donneesSauvees = localStorage.getItem('cotisationsData');
      if (donneesSauvees) {
        const donnees = JSON.parse(donneesSauvees);
        personnes = donnees.personnes || [];
        cotisationsSemaine = donnees.cotisationsSemaine || {};
        historique = donnees.historique || [];
        montantCotisation = donnees.montantCotisation || 100;
        
        // Assurer une structure correcte pour groupesConfig
        if (donnees.groupesConfig) {
          groupesConfig = {
            courses: {
              groupes: donnees.groupesConfig.courses?.groupes || [[], [], []],
              noms: donnees.groupesConfig.courses?.noms || ['Groupe A', 'Groupe B', 'Groupe C'],
              taches: donnees.groupesConfig.courses?.taches || ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
            },
            menage: {
              groupes: donnees.groupesConfig.menage?.groupes || [[], []],
              noms: donnees.groupesConfig.menage?.noms || ['Groupe 1', 'Groupe 2'],
              taches: donnees.groupesConfig.menage?.taches || ['Fait le m√©nage', 'Se repose']
            }
          };
        }
        
        loyerData = donnees.loyerData || {
          total: 3000,
          paiements: [],
          depensesImprevues: []
        };
        tachesHistorique = donnees.tachesHistorique || [];
        
        // Charger l'√©tat d'authentification
        isRentAuthenticated = localStorage.getItem('rentAuthenticated') === 'true';
        rentPasswordSet = localStorage.getItem('rentPasswordSet') === 'true';
      } else {
        // Initialisation des donn√©es par d√©faut
        personnes = [];
        cotisationsSemaine = {};
        historique = [];
        montantCotisation = 100;
        groupesConfig = {
          courses: {
            groupes: [[], [], []],
            noms: ['Groupe A', 'Groupe B', 'Groupe C'],
            taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
          },
          menage: {
            groupes: [[], []],
            noms: ['Groupe 1', 'Groupe 2'],
            taches: ['Fait le m√©nage', 'Se repose']
          }
        };
        loyerData = {
          total: 3000,
          paiements: [],
          depensesImprevues: []
        };
        tachesHistorique = [];
        isRentAuthenticated = false;
        rentPasswordSet = false;
      }
    }

    // Sauvegarde des donn√©es
    function sauvegarderDonnees() {
      const donnees = {
        personnes: personnes,
        cotisationsSemaine: cotisationsSemaine,
        historique: historique,
        montantCotisation: montantCotisation,
        groupesConfig: groupesConfig,
        loyerData: loyerData,
        tachesHistorique: tachesHistorique
      };
      localStorage.setItem('cotisationsData', JSON.stringify(donnees));
      
      // Synchroniser avec Firebase
      sauvegarderSurFirebase();
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      // G√©n√©rer un ID utilisateur unique s'il n'existe pas
      if (!localStorage.getItem('userId')) {
        localStorage.setItem('userId', Date.now().toString());
      }
      
      chargerDonnees();
      mettreAJourSemaine();
      rendreCotisations();
      rendrePersonnes();
      rendreHistorique();
      rendreTaches();
      
      // Mettre √† jour l'affichage du montant
      document.getElementById('montantCotisation').value = montantCotisation;
      document.getElementById('montantCotisationDisplay').textContent = montantCotisation;
      
      // Initialiser la date aujourd'hui pour les champs de date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('rentDate').value = today;
      document.getElementById('expenseDate').value = today;
      
      // Initialiser Firebase
      chargerDepuisFirebase();
      
      // Synchroniser imm√©diatement au chargement
      setTimeout(sauvegarderSurFirebase, 1000);
      
      // Synchroniser toutes les 10 secondes
      setInterval(sauvegarderSurFirebase, 10000);
    });

    // Gestion des sections
    function showSection(nomSection) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(nomSection).classList.add('active');
      
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Si on acc√®de √† la section loyer, v√©rifier l'authentification
      if (nomSection === 'depenses') {
        mettreAJourRentAccess();
      }
    }

    // Mise √† jour de la semaine actuelle
    function mettreAJourSemaine() {
      const maintenant = new Date();
      const jour = maintenant.getDay(); // 0 = dimanche, 6 = samedi
      const dimanche = new Date(maintenant);
      
      // Calculer le dimanche de la semaine en cours
      dimanche.setDate(maintenant.getDate() - (jour === 0 ? 0 : jour));
      dimanche.setHours(0, 0, 0, 0);
      
      // Mettre √† jour l'affichage
      document.getElementById('currentWeek').textContent = 
        `Semaine du ${dimanche.toLocaleDateString('fr-FR')} au ${new Date(dimanche.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString('fr-FR')}`;
      
      return { dimanche, maintenant };
    }

    // Afficher notification
    function afficherNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Ajouter une personne
    function addPerson() {
      const input = document.getElementById('personName');
      const nom = input.value.trim();
      
      if (!nom) {
        afficherNotification('Veuillez entrer un nom.', 'error');
        return;
      }
      
      const id = Date.now();
      const maintenant = new Date();
      
      personnes.push({
        id: id,
        nom: nom,
        dateAjout: maintenant.toISOString()
      });
      
      // Initialiser les cotisations pour la nouvelle personne
      cotisationsSemaine[id] = { paye: false, dette: 0 };
      
      sauvegarderDonnees();
      rendrePersonnes();
      rendreCotisations();
      input.value = '';
      afficherNotification(`${nom} ajout√© avec succ√®s !`);
    }

    // Supprimer une personne
    function supprimerPersonne(idPersonne) {
      const personne = personnes.find(p => p.id === idPersonne);
      if (!personne) return;
      
      if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${personne.nom} ?`)) {
        personnes = personnes.filter(p => p.id !== idPersonne);
        delete cotisationsSemaine[idPersonne];
        
        // Retirer la personne des groupes
        Object.keys(groupesConfig).forEach(type => {
          groupesConfig[type].groupes.forEach(groupe => {
            const index = groupe.indexOf(idPersonne);
            if (index !== -1) {
              groupe.splice(index, 1);
            }
          });
        });
        
        // Retirer la personne des paiements de loyer
        loyerData.paiements = loyerData.paiements.filter(p => p.personneId !== idPersonne);
        
        sauvegarderDonnees();
        rendrePersonnes();
        rendreCotisations();
        rendreTaches();
        mettreAJourLoyer();
        afficherNotification(`${personne.nom} supprim√©.`);
      }
    }

    // Toggle paiement
    function togglePaiement(idPersonne) {
      if (cotisationsSemaine[idPersonne]) {
        cotisationsSemaine[idPersonne].paye = !cotisationsSemaine[idPersonne].paye;
        sauvegarderDonnees();
        rendreCotisations();
      }
    }

    // Mettre √† jour la dette
    function mettreAJourDette(idPersonne, montant) {
      const dette = parseFloat(montant) || 0;
      if (cotisationsSemaine[idPersonne]) {
        cotisationsSemaine[idPersonne].dette = dette;
        sauvegarderDonnees();
        rendreCotisations();
      }
    }

    // Changer le montant de la cotisation
    function changerMontantCotisation() {
      const input = document.getElementById('montantCotisation');
      const nouveauMontant = parseInt(input.value);
      
      if (isNaN(nouveauMontant) || nouveauMontant <= 0) {
        afficherNotification('Veuillez entrer un montant valide.', 'error');
        return;
      }
      
      const ancienMontant = montantCotisation;
      montantCotisation = nouveauMontant;
      sauvegarderDonnees();
      rendreCotisations();
      
      // Mettre √† jour l'affichage
      document.getElementById('montantCotisationDisplay').textContent = montantCotisation;
      afficherNotification(`Montant de la cotisation modifi√© de ${ancienMontant} DH √† ${montantCotisation} DH !`);
    }

    // Rendu des cotisations
    function rendreCotisations() {
      const grid = document.getElementById('paymentGrid');
      
      if (personnes.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üë•</div>
            <h3>Aucune personne ajout√©e</h3>
            <p>Ajoutez des membres dans la section "Personnes" pour commencer.</p>
          </div>
        `;
        mettreAJourStatistiques();
        return;
      }
      
      grid.innerHTML = personnes.map(personne => {
        const cotisation = cotisationsSemaine[personne.id] || { paye: false, dette: 0 };
        return `
          <div class="person-card">
            <div class="person-name">${personne.nom}</div>
            <div class="payment-status">
              <button class="btn ${cotisation.paye ? 'btn-secondary' : 'btn-primary'}" 
                      onclick="togglePaiement(${personne.id})">
                ${cotisation.paye ? 'Marquer non pay√©' : 'Marquer pay√©'}
              </button>
              <span class="status ${cotisation.paye ? 'status-paid' : 'status-unpaid'}">
                ${cotisation.paye ? 'Pay√©' : 'Non pay√©'}
              </span>
            </div>
            <div class="dette-input">
              <span>Dette (DH):</span>
              <input type="number" min="0" value="${cotisation.dette || 0}" 
                     onchange="mettreAJourDette(${personne.id}, this.value)">
            </div>
          </div>
        `;
      }).join('');
      
      mettreAJourStatistiques();
    }

    // Mise √† jour des statistiques
    function mettreAJourStatistiques() {
      const total = personnes.length;
      const payes = Object.values(cotisationsSemaine).filter(c => c.paye).length;
      const totalDettes = Object.values(cotisationsSemaine).reduce((sum, c) => sum + (c.paye ? c.dette : 0), 0);
      const totalCollecte = (payes * montantCotisation) - totalDettes;
      
      document.getElementById('totalPersonnes').textContent = total;
      document.getElementById('totalPaye').textContent = payes;
      document.getElementById('totalDettes').textContent = totalDettes;
      document.getElementById('totalCollecte').textContent = totalCollecte;
    }

    // Rendu des personnes
    function rendrePersonnes() {
      const liste = document.getElementById('peopleList');
      
      if (personnes.length === 0) {
        liste.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üë§</div>
            <h3>Aucun membre</h3>
            <p>Ajoutez les membres de votre maison ci-dessus.</p>
          </div>
        `;
        return;
      }
      
      liste.innerHTML = personnes.map(personne => `
        <div class="person-item">
          <div class="person-info">
            <h3>${personne.nom}</h3>
            <small>Membre depuis le ${new Date(personne.dateAjout).toLocaleDateString('fr-FR')}</small>
          </div>
          <div>
            <button class="btn btn-danger" onclick="supprimerPersonne(${personne.id})">üóëÔ∏è Supprimer</button>
          </div>
        </div>
      `).join('');
    }

    // Rendu des t√¢ches
    function rendreTaches() {
      // Rendre la configuration des groupes
      rendreConfigGroupes();
      
      // Rendre les t√¢ches de la semaine
      rendreTachesSemaine();
    }

      // Rendre la configuration des groupes
    function rendreConfigGroupes() {
      // Courses
      const coursesConfig = document.getElementById('coursesGroupsConfig');
      if (coursesConfig) {
        let coursesHtml = '';
        
        // V√©rifications RENFORC√âES pour s'assurer que c'est un tableau
        if (groupesConfig.courses && 
            Array.isArray(groupesConfig.courses.groupes) && 
            groupesConfig.courses.groupes.length > 0) {
          
          groupesConfig.courses.groupes.forEach((groupe, index) => {
            coursesHtml += `
              <div class="group-item">
                <div class="group-title">${groupesConfig.courses.noms[index] || 'Groupe ' + (index + 1)}</div>
                <div class="group-members">
                  ${Array.isArray(groupe) ? groupe.map(id => {
                    const personne = personnes.find(p => p.id === id);
                    return personne ? `<span class="member-tag">${personne.nom}</span>` : '';
                  }).join('') : ''}
                  ${Array.isArray(groupe) && groupe.length === 0 ? '<small>Aucun membre</small>' : ''}
                </div>
              </div>
            `;
          });
        } else {
          // R√©initialiser avec des valeurs par d√©faut si n√©cessaire
          groupesConfig.courses = {
            groupes: [[], [], []],
            noms: ['Groupe A', 'Groupe B', 'Groupe C'],
            taches: ['Ach√®te le poulet', 'Fait les courses', 'Se repose']
          };
        }
        
        coursesConfig.innerHTML = coursesHtml;
      }
      
      // M√©nage
      const menageConfig = document.getElementById('menageGroupsConfig');
      if (menageConfig) {
        let menageHtml = '';
        
        // V√©rifications RENFORC√âES pour s'assurer que c'est un tableau
        if (groupesConfig.menage && 
            Array.isArray(groupesConfig.menage.groupes) && 
            groupesConfig.menage.groupes.length > 0) {
          
          groupesConfig.menage.groupes.forEach((groupe, index) => {
            menageHtml += `
              <div class="group-item">
                <div class="group-title">${groupesConfig.menage.noms[index] || 'Groupe ' + (index + 1)}</div>
                <div class="group-members">
                  ${Array.isArray(groupe) ? groupe.map(id => {
                    const personne = personnes.find(p => p.id === id);
                    return personne ? `<span class="member-tag">${personne.nom}</span>` : '';
                  }).join('') : ''}
                  ${Array.isArray(groupe) && groupe.length === 0 ? '<small>Aucun membre</small>' : ''}
                </div>
              </div>
            `;
          });
        } else {
          // R√©initialiser avec des valeurs par d√©faut si n√©cessaire
          groupesConfig.menage = {
            groupes: [[], []],
            noms: ['Groupe 1', 'Groupe 2'],
            taches: ['Fait le m√©nage', 'Se repose']
          };
        }
        
        menageConfig.innerHTML = menageHtml;
      }
    }

    // Rendre les t√¢ches de la semaine
    function rendreTachesSemaine() {
      const maintenant = new Date();
      const dimanche = new Date(maintenant);
      dimanche.setDate(maintenant.getDate() - maintenant.getDay());
      dimanche.setHours(0, 0, 0, 0);
      
      // Calculer le nombre de semaines √©coul√©es depuis une date de r√©f√©rence
      const dateRef = new Date(2023, 0, 1); // 1er janvier 2023
      const diffWeeks = Math.floor((dimanche - dateRef) / (7 * 24 * 60 * 60 * 1000));
      
      // Rotation des groupes pour les courses (3 groupes)
      const rotationCourses = diffWeeks % 3;
      
      // Rotation des groupes pour le m√©nage (2 groupes)
      const rotationMenage = diffWeeks % 2;
      
      let html = `
        <div class="task-card" style="border-left-color: #48bb78;">
          <div class="task-header" style="border-bottom-color: #e2e8f0;">
            <div>
              <div class="task-title" style="color: #2d3748;">üõí Courses et poulet</div>
              <small style="color: #718096;">Rotation hebdomadaire des groupes</small>
            </div>
          </div>
          <div class="task-group">
      `;
      
      // Afficher les groupes avec leurs t√¢ches pour cette semaine
      for (let i = 0; i < 3; i++) {
        const groupeIndex = (i + rotationCourses) % 3;
        
        // CORRECTION : V√©rifier si groupesConfig.courses.groupes existe et est un tableau
        const groupe = Array.isArray(groupesConfig.courses?.groupes) && 
                      groupesConfig.courses.groupes[groupeIndex] !== null &&
                      Array.isArray(groupesConfig.courses.groupes[groupeIndex]) ?
                      groupesConfig.courses.groupes[groupeIndex] : [];
                      
        const tacheIndex = (i + rotationCourses) % 3;
        
        html += `
          <div class="group-item" style="border-left-color: #48bb78;">
            <div class="group-title">${groupesConfig.courses.noms[groupeIndex] || 'Groupe ' + (groupeIndex + 1)} : ${groupesConfig.courses.taches[tacheIndex] || 'T√¢che non d√©finie'}</div>
            <div class="group-members">
              ${groupe.map(id => {
                const personne = personnes.find(p => p.id === id);
                return personne ? `<span class="member-tag">${personne.nom}</span>` : '';
              }).join('')}
              ${groupe.length === 0 ? '<small style="color: #718096;">Aucun membre</small>' : ''}
            </div>
          </div>
        `;
      }
      
      html += `</div></div>`;
      
      // T√¢ches de m√©nage
      html += `
        <div class="task-card" style="border-left-color: #ed8936;">
          <div class="task-header" style="border-bottom-color: #e2e8f0;">
            <div>
              <div class="task-title" style="color: #2d3748;">üßπ M√©nage</div>
              <small style="color: #718096;">Rotation hebdomadaire des groupes</small>
            </div>
          </div>
          <div class="task-group">
      `;
      
      for (let i = 0; i < 2; i++) {
        const groupeIndex = (i + rotationMenage) % 2;
        
        // CORRECTION : V√©rifier si groupesConfig.menage.groupes existe et est un tableau
        const groupe = Array.isArray(groupesConfig.menage?.groupes) && 
                      groupesConfig.menage.groupes[groupeIndex] !== null &&
                      Array.isArray(groupesConfig.menage.groupes[groupeIndex]) ?
                      groupesConfig.menage.groupes[groupeIndex] : [];
                      
        const tacheIndex = (i + rotationMenage) % 2;
        
        html += `
          <div class="group-item" style="border-left-color: #ed8936;">
            <div class="group-title">${groupesConfig.menage.noms[groupeIndex] || 'Groupe ' + (groupeIndex + 1)} : ${groupesConfig.menage.taches[tacheIndex] || 'T√¢che non d√©finie'}</div>
            <div class="group-members">
              ${groupe.map(id => {
                const personne = personnes.find(p => p.id === id);
                return personne ? `<span class="member-tag">${personne.nom}</span>` : '';
              }).join('')}
              ${groupe.length === 0 ? '<small style="color: #718096;">Aucun membre</small>' : ''}
            </div>
          </div>
        `;
      }
      
      html += `</div></div>`;
      
      document.getElementById('currentTasks').innerHTML = html;
    }

    // Ouvrir la modal de configuration des groupes
    function openGroupModal(type) {
      // D√©terminer le nombre de semaines √©coul√©es pour afficher la rotation actuelle
      const maintenant = new Date();
      const dimanche = new Date(maintenant);
      dimanche.setDate(maintenant.getDate() - maintenant.getDay());
      dimanche.setHours(0, 0, 0, 0);
      
      // Calculer le nombre de semaines √©coul√©es depuis une date de r√©f√©rence
      const dateRef = new Date(2023, 0, 1); // 1er janvier 2023
      const diffWeeks = Math.floor((dimanche - dateRef) / (7 * 24 * 60 * 60 * 1000));
      
      // Configuration pour les courses (3 groupes)
      if (type === 'courses') {
        document.getElementById('groupModalTitle').textContent = 'Configurer les groupes pour les courses/poulet';
        
        // Instructions d√©taill√©es pour la configuration
        document.getElementById('groupInstructions').innerHTML = `
          <h4>Comment configurer les groupes ?</h4>
          <p>Attribuez les membres √† chaque groupe. La rotation des t√¢ches fonctionne selon ce cycle de 3 semaines :</p>
          <ul>
            <li><strong>Semaine ${diffWeeks % 3 + 1} sur 3 :</strong> 
              ${diffWeeks % 3 === 0 ? 
                'Groupe A ach√®te le poulet, Groupe B fait les courses, Groupe C se repose' : 
                diffWeeks % 3 === 1 ?
                'Groupe A fait les courses, Groupe B se repose, Groupe C ach√®te le poulet' :
                'Groupe A se repose, Groupe B ach√®te le poulet, Groupe C fait les courses'}
            </li>
            <li>Semaine suivante : rotation des t√¢ches entre les groupes</li>
          </ul>
          <p>Assurez-vous d'avoir 2 personnes par groupe pour un √©quilibre parfait.</p>
        `;
        
        document.getElementById('groupConfigContent').innerHTML = `
          <div style="margin-bottom: 15px;">
            <small style="color: #718096;">Renommez vos groupes si vous le souhaitez :</small>
          </div>
          <div style="margin-bottom: 20px;">
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span>Groupe 1 :</span>
                <input type="text" id="courseGroup1Name" class="form-input" value="${groupesConfig.courses.noms[0]}" style="flex: 1;">
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span>Groupe 2 :</span>
                <input type="text" id="courseGroup2Name" class="form-input" value="${groupesConfig.courses.noms[1]}" style="flex: 1;">
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span>Groupe 3 :</span>
                <input type="text" id="courseGroup3Name" class="form-input" value="${groupesConfig.courses.noms[2]}" style="flex: 1;">
              </div>
            </div>
          </div>
        `;
        
        // Configuration des groupes avec leurs t√¢ches actuelles
        let groupConfiguration = '';
        for (let i = 0; i < 3; i++) {
          const groupeIndex = i;
          const tacheIndex = (i + diffWeeks) % 3;
          
          groupConfiguration += `
            <div class="group-config">
              <div class="group-config-header">
                <div class="group-config-title">${groupesConfig.courses.noms[groupeIndex]}</div>
              </div>
              <div class="group-config-task">
                Semaine prochaine : ${groupesConfig.courses.taches[tacheIndex]}
              </div>
              <div class="members-list" id="groupCourses${groupeIndex}" ondragover="allowDrop(event)" ondrop="drop(event, ${groupeIndex}, 'courses')">
                ${groupesConfig.courses.groupes[groupeIndex].map(id => {
                  const personne = personnes.find(p => p.id === id);
                  return personne ? 
                    `<span class="member-tag" draggable="true" ondragstart="drag(event, ${id}, ${groupeIndex}, 'courses')">${personne.nom} <span class="remove-member" onclick="removeFromGroup('courses', ${groupeIndex}, ${id})">√ó</span></span>` : '';
                }).join('')}
                ${groupesConfig.courses.groupes[groupeIndex].length === 0 ? '<small>Aucun membre</small>' : ''}
              </div>
            </div>
          `;
        }
        document.getElementById('groupConfiguration').innerHTML = groupConfiguration;
      } else {
        // Configuration pour le m√©nage (2 groupes)
        document.getElementById('groupModalTitle').textContent = 'Configurer les groupes pour le m√©nage';
        
        // Instructions d√©taill√©es pour la configuration
        document.getElementById('groupInstructions').innerHTML = `
          <h4>Comment configurer les groupes ?</h4>
          <p>Attribuez les membres √† chaque groupe. La rotation des t√¢ches fonctionne selon ce cycle de 2 semaines :</p>
          <ul>
            <li><strong>Semaine ${diffWeeks % 2 === 0 ? 'paire' : 'impaire'} :</strong> 
              ${diffWeeks % 2 === 0 ? 
                'Groupe 1 fait le m√©nage, Groupe 2 se repose' :
                'Groupe 1 se repose, Groupe 2 fait le m√©nage'}
            </li>
            <li>Semaine suivante : rotation des t√¢ches entre les groupes</li>
          </ul>
          <p>Assurez-vous d'avoir un nombre √©quilibr√© de personnes dans chaque groupe.</p>
        `;
        
        document.getElementById('groupConfigContent').innerHTML = `
          <p style="margin-bottom: 15px; color: #4a5568;">Renommez vos groupes si vous le souhaitez :</p>
          <div style="margin-bottom: 20px;">
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span>Groupe 1 :</span>
                <input type="text" id="menageGroup1Name" class="form-input" value="${groupesConfig.menage.noms[0]}" style="flex: 1;">
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span>Groupe 2 :</span>
                <input type="text" id="menageGroup2Name" class="form-input" value="${groupesConfig.menage.noms[1]}" style="flex: 1;">
              </div>
            </div>
          </div>
        `;
        
        // Configuration des groupes avec leurs t√¢ches actuelles
        let groupConfiguration = '';
        for (let i = 0; i < 2; i++) {
          const groupeIndex = i;
          const tacheIndex = (i + diffWeeks) % 2;
          
          groupConfiguration += `
            <div class="group-config">
              <div class="group-config-header">
                <div class="group-config-title">${groupesConfig.menage.noms[groupeIndex]}</div>
              </div>
              <div class="group-config-task">
                Semaine prochaine : ${groupesConfig.menage.taches[tacheIndex]}
              </div>
              <div class="members-list" id="groupMenage${groupeIndex}" ondragover="allowDrop(event)" ondrop="drop(event, ${groupeIndex}, 'menage')">
                ${groupesConfig.menage.groupes[groupeIndex].map(id => {
                  const personne = personnes.find(p => p.id === id);
                  return personne ? 
                    `<span class="member-tag" draggable="true" ondragstart="drag(event, ${id}, ${groupeIndex}, 'menage')">${personne.nom} <span class="remove-member" onclick="removeFromGroup('menage', ${groupeIndex}, ${id})">√ó</span></span>` : '';
                }).join('')}
                ${groupesConfig.menage.groupes[groupeIndex].length === 0 ? '<small>Aucun membre</small>' : ''}
              </div>
            </div>
          `;
        }
        document.getElementById('groupConfiguration').innerHTML = groupConfiguration;
      }
      
      // Afficher les personnes disponibles
      let membersHtml = '';
      personnes.forEach(personne => {
        // V√©rifier si la personne est d√©j√† dans un groupe
        let isInGroup = false;
        if (type === 'courses') {
          for (let i = 0; i < 3; i++) {
            if (groupesConfig.courses.groupes[i].includes(personne.id)) {
              isInGroup = true;
              break;
            }
          }
        } else {
          for (let i = 0; i < 2; i++) {
            if (groupesConfig.menage.groupes[i].includes(personne.id)) {
              isInGroup = true;
              break;
            }
          }
        }
        
        if (!isInGroup) {
          membersHtml += `
            <div class="person-item" draggable="true" ondragstart="drag(event, ${personne.id}, -1, '${type}')" 
                 style="padding: 10px; background: #f7fafc; border-radius: 8px; cursor: move; transition: all 0.2s;" 
                 onmouseover="this.style.backgroundColor='#edf2f7'" 
                 onmouseout="this.style.backgroundColor='#f7fafc'">
              ${personne.nom}
            </div>
          `;
        }
      });
      
      if (membersHtml === '') {
        membersHtml = '<p>Aucun membre disponible - tous sont d√©j√† assign√©s √† un groupe</p>';
      }
      
      document.getElementById('availableMembers').innerHTML = membersHtml;
      
      // Afficher la modal
      document.getElementById('groupModal').style.display = 'flex';
    }

    // Fonction de glisser-d√©poser
    function drag(ev, personId, sourceGroup, type) {
      ev.dataTransfer.setData("personId", personId);
      ev.dataTransfer.setData("sourceGroup", sourceGroup);
      ev.dataTransfer.setData("type", type);
    }

    function allowDrop(ev) {
      ev.preventDefault();
      ev.currentTarget.classList.add('drag-over');
    }

    function drop(ev, targetGroup, type) {
      ev.preventDefault();
      ev.currentTarget.classList.remove('drag-over');
      
      const personId = parseInt(ev.dataTransfer.getData("personId"));
      const sourceGroup = parseInt(ev.dataTransfer.getData("sourceGroup"));
      const dragType = ev.dataTransfer.getData("type");
      
      // V√©rifier si on d√©place dans le bon type de groupe
      if (dragType !== type) return;
      
      // Retirer de l'ancien groupe
      if (sourceGroup !== -1) {
        if (type === 'courses') {
          groupesConfig.courses.groupes[sourceGroup] = groupesConfig.courses.groupes[sourceGroup].filter(id => id !== personId);
        } else {
          groupesConfig.menage.groupes[sourceGroup] = groupesConfig.menage.groupes[sourceGroup].filter(id => id !== personId);
        }
      }
      
      // Ajouter au nouveau groupe
      if (type === 'courses') {
        // V√©rifier si le groupe est d√©j√† plein (2 personnes max)
        if (groupesConfig.courses.groupes[targetGroup].length < 2) {
          groupesConfig.courses.groupes[targetGroup].push(personId);
        } else {
          afficherNotification('Ce groupe est d√©j√† complet (2 personnes max)', 'error');
          return;
        }
      } else {
        // V√©rifier si le groupe est d√©j√† plein
        if (groupesConfig.menage.groupes[targetGroup].length < Math.ceil(personnes.length / 2)) {
          groupesConfig.menage.groupes[targetGroup].push(personId);
        } else {
          afficherNotification('Ce groupe est d√©j√† complet', 'error');
          return;
        }
      }
      
      // Rafra√Æchir l'interface
      openGroupModal(type);
    }

    // Retirer une personne d'un groupe
    function removeFromGroup(type, groupIndex, personId) {
      if (type === 'courses') {
        const index = groupesConfig.courses.groupes[groupIndex].indexOf(personId);
        if (index !== -1) {
          groupesConfig.courses.groupes[groupIndex].splice(index, 1);
        }
      } else {
        const index = groupesConfig.menage.groupes[groupIndex].indexOf(personId);
        if (index !== -1) {
          groupesConfig.menage.groupes[groupIndex].splice(index, 1);
        }
      }
      
      // Rafra√Æchir l'interface
      openGroupModal(type);
    }

    // Sauvegarder la configuration des groupes
    function saveGroupConfig() {
      const type = document.getElementById('groupModalTitle').textContent.includes('courses') ? 'courses' : 'menage';
      
      if (type === 'courses') {
        const group1Name = document.getElementById('courseGroup1Name').value.trim() || 'Groupe A';
        const group2Name = document.getElementById('courseGroup2Name').value.trim() || 'Groupe B';
        const group3Name = document.getElementById('courseGroup3Name').value.trim() || 'Groupe C';
        groupesConfig.courses.noms = [group1Name, group2Name, group3Name];
      } else {
        const group1Name = document.getElementById('menageGroup1Name').value.trim() || 'Groupe 1';
        const group2Name = document.getElementById('menageGroup2Name').value.trim() || 'Groupe 2';
        groupesConfig.menage.noms = [group1Name, group2Name];
      }
      
      sauvegarderDonnees();
      rendreTaches();
      closeGroupModal();
      afficherNotification(`Configuration des groupes ${type === 'courses' ? 'pour les courses' : 'pour le m√©nage'} sauvegard√©e !`);
    }

    // Fermer la modal de configuration des groupes
    function closeGroupModal() {
      document.getElementById('groupModal').style.display = 'none';
    }

    // Rendu de l'historique
    function rendreHistorique() {
      const grid = document.getElementById('historyGrid');
      
      if (historique.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìÖ</div>
            <h3>Aucune semaine sauvegard√©e</h3>
            <p>Les semaines seront sauvegard√©es automatiquement chaque samedi √† 23h59.</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = historique.map(semaine => {
        const dateDebut = new Date(semaine.dateDebut);
        const dateFin = new Date(semaine.dateFin);
        
        // Calculer le total des cotisations
        const totalCotisations = Object.values(semaine.cotisations).reduce((sum, c) => {
          return sum + (c.paye ? semaine.montantCotisation : 0);
        }, 0);
        
        // Cr√©er la liste des personnes avec leur statut
        let personnesListe = '';
        semaine.personnes.forEach(personne => {
          const cotisation = semaine.cotisations[personne.id] || { paye: false, dette: 0 };
          
          personnesListe += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
              <div>
                <span style="font-weight: 500;">${personne.nom}</span>
                <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; background: ${cotisation.paye ? '#c6f6d5' : '#fed7d7'}; color: ${cotisation.paye ? '#2f855a' : '#c53030'};">
                  ${cotisation.paye ? 'Pay√©' : 'Non pay√©'}
                </span>
              </div>
              ${cotisation.dette > 0 ? `<div style="font-weight: 600; color: #c53030;">${cotisation.dette} DH</div>` : ''}
            </div>
          `;
        });
        
        return `
          <div class="history-card">
            <div class="history-header">
              <div class="history-title">Semaine du ${dateDebut.toLocaleDateString('fr-FR')}</div>
              <div class="history-date">${dateDebut.toLocaleDateString('fr-FR')} - ${dateFin.toLocaleDateString('fr-FR')}</div>
            </div>
            <div class="history-details">
              <div class="detail-item">
                <div class="detail-label">Personnes</div>
                <div class="detail-value">${semaine.personnes.length}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Cotisation</div>
                <div class="detail-value">${semaine.montantCotisation} DH</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Cotisations pay√©es</div>
                <div class="detail-value">${Object.values(semaine.cotisations).filter(c => c.paye).length}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Total collect√©</div>
                <div class="detail-value">${totalCotisations} DH</div>
              </div>
            </div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
              <h4 style="margin-bottom: 10px; color: #2d3748;">Statut des paiements</h4>
              <div style="max-height: 200px; overflow-y: auto;">
                ${personnesListe}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Sauvegarde manuelle de la semaine
    function sauvegarderManuellement() {
      if (personnes.length === 0) {
        afficherNotification('Aucune personne √† sauvegarder.', 'error');
        return;
      }
      
      const maintenant = new Date();
      const { dimanche } = mettreAJourSemaine();
      const vendredi = new Date(dimanche);
      vendredi.setDate(dimanche.getDate() + 5);
      
      const donneesSemaine = {
        id: `semaine_${dimanche.getTime()}_manuel`,
        dateDebut: dimanche.toISOString(),
        dateFin: vendredi.toISOString(),
        personnes: [...personnes],
        cotisations: {...cotisationsSemaine},
        montantCotisation: montantCotisation,
        dateSauvegarde: maintenant.toISOString(),
        automatique: false
      };
      
      historique.unshift(donneesSemaine);
      
      // Garder seulement les 5 derni√®res semaines
      if (historique.length > 5) {
        historique = historique.slice(0, 5);
      }
      
      sauvegarderDonnees();
      rendreHistorique();
      afficherNotification('‚úÖ Semaine sauvegard√©e manuellement !');
    }

    // √âv√©nement pour Enter dans le champ nom
    document.addEventListener('keypress', function(e) {
      if (e.target.id === 'personName' && e.key === 'Enter') {
        addPerson();
      }
    });

    // === GESTION LOYER & DEPENSES ===
    
    // V√©rifier le mot de passe pour acc√©der √† la section loyer
    function checkRentPassword() {
      const passwordInput = document.getElementById('rentPassword');
      const password = passwordInput.value;
      
      if (password === rentPassword) {
        isRentAuthenticated = true;
        localStorage.setItem('rentAuthenticated', 'true');
        document.getElementById('rentLockScreen').style.display = 'none';
        document.getElementById('rentContent').style.display = 'block';
        mettreAJourLoyer();
        passwordInput.value = '';
        afficherNotification('Acc√®s autoris√© √† la gestion des loyers et d√©penses.');
      } else {
        afficherNotification('Mot de passe incorrect.', 'error');
        passwordInput.value = '';
      }
    }

    // Ouvrir la modal de configuration du mot de passe
    function openPasswordModal() {
      document.getElementById('passwordModal').style.display = 'flex';
    }

    // Fermer la modal de configuration du mot de passe
    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
    }

    // Configurer le mot de passe
    function setRentPassword() {
      const newPassword = document.getElementById('rentNewPassword').value;
      const confirmPassword = document.getElementById('rentConfirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        afficherNotification('Les mots de passe ne correspondent pas.', 'error');
        return;
      }
      
      if (newPassword.length < 4) {
        afficherNotification('Le mot de passe doit contenir au moins 4 caract√®res.', 'error');
        return;
      }
      
      // Mettre √† jour les variables locales
      rentPasswordSet = true;
      rentPassword = newPassword;
      
      // Mettre √† jour Firebase
      sauvegarderSurFirebase();
      
      // Mettre √† jour l'interface
      closePasswordModal();
      afficherNotification('Mot de passe configur√© avec succ√®s !');
    }

    // Ouvrir la modal de paiement du loyer
    function openRentPaymentModal() {
      // Remplir la liste des personnes
      const personSelect = document.getElementById('rentPerson');
      personSelect.innerHTML = '';
      
      personnes.forEach(personne => {
        const option = document.createElement('option');
        option.value = personne.id;
        option.textContent = personne.nom;
        personSelect.appendChild(option);
      });
      
      // Ouvrir la modal
      document.getElementById('rentPaymentModal').style.display = 'flex';
    }

    // Fermer la modal de paiement du loyer
    function closeRentPaymentModal() {
      document.getElementById('rentPaymentModal').style.display = 'none';
    }

    // Enregistrer un paiement de loyer
    function saveRentPayment() {
      const personId = parseInt(document.getElementById('rentPerson').value);
      const amount = parseFloat(document.getElementById('rentAmount').value);
      const date = document.getElementById('rentDate').value;
      
      if (isNaN(amount) || amount <= 0) {
        afficherNotification('Veuillez entrer un montant valide.', 'error');
        return;
      }
      
      if (!date) {
        afficherNotification('Veuillez s√©lectionner une date.', 'error');
        return;
      }
      
      // Ajouter le paiement
      loyerData.paiements.push({
        id: Date.now(),
        personneId: personId,
        montant: amount,
        date: date
      });
      
      sauvegarderDonnees();
      closeRentPaymentModal();
      mettreAJourLoyer();
      afficherNotification('Paiement du loyer enregistr√© avec succ√®s !');
    }

    // Supprimer un paiement de loyer
    function deleteRentPayment(paymentId) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer ce paiement ?')) {
        loyerData.paiements = loyerData.paiements.filter(p => p.id !== paymentId);
        sauvegarderDonnees();
        mettreAJourLoyer();
        afficherNotification('Paiement supprim√© avec succ√®s.');
      }
    }

    // Ouvrir la modal d'ajout de d√©pense
    function openExpenseModal() {
      document.getElementById('expenseModal').style.display = 'flex';
    }

    // Fermer la modal d'ajout de d√©pense
    function closeExpenseModal() {
      document.getElementById('expenseModal').style.display = 'none';
    }

    // Enregistrer une d√©pense
    function saveExpense() {
      const name = document.getElementById('expenseName').value.trim();
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const date = document.getElementById('expenseDate').value;
      
      if (!name) {
        afficherNotification('Veuillez entrer une description pour la d√©pense.', 'error');
        return;
      }
      
      if (isNaN(amount) || amount <= 0) {
        afficherNotification('Veuillez entrer un montant valide.', 'error');
        return;
      }
      
      if (!date) {
        afficherNotification('Veuillez s√©lectionner une date.', 'error');
        return;
      }
      
      // Ajouter la d√©pense
      loyerData.depensesImprevues.push({
        id: Date.now(),
        nom: name,
        montant: amount,
        date: date
      });
      
      sauvegarderDonnees();
      closeExpenseModal();
      mettreAJourLoyer();
      afficherNotification('D√©pense impr√©vue enregistr√©e avec succ√®s !');
    }

    // Supprimer une d√©pense
    function deleteExpense(expenseId) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense ?')) {
        loyerData.depensesImprevues = loyerData.depensesImprevues.filter(e => e.id !== expenseId);
        sauvegarderDonnees();
        mettreAJourLoyer();
        afficherNotification('D√©pense supprim√©e avec succ√®s.');
      }
    }

    // Ouvrir la modal de configuration du loyer
    function openRentConfigModal() {
      document.getElementById('rentAmountConfig').value = loyerData.total;
      document.getElementById('rentConfigModal').style.display = 'flex';
    }

    // Fermer la modal de configuration du loyer
    function closeRentConfigModal() {
      document.getElementById('rentConfigModal').style.display = 'none';
    }

    // Sauvegarder la configuration du loyer
    function saveRentConfig() {
      const newRentAmount = parseInt(document.getElementById('rentAmountConfig').value);
      
      if (isNaN(newRentAmount) || newRentAmount <= 0) {
        afficherNotification('Veuillez entrer un montant de loyer valide.', 'error');
        return;
      }
      
      const oldRentAmount = loyerData.total;
      loyerData.total = newRentAmount;
      sauvegarderDonnees();
      closeRentConfigModal();
      mettreAJourLoyer();
      afficherNotification(`Montant du loyer modifi√© de ${oldRentAmount} DH √† ${newRentAmount} DH !`);
    }

    // Mettre √† jour l'affichage du loyer
    function mettreAJourLoyer() {
      // Calculer les totaux
      const totalLoyer = loyerData.total;
      
      // CORRECTION : V√©rifier si paiements existe et est un tableau
      const loyerPaye = Array.isArray(loyerData.paiements) ? 
        loyerData.paiements.reduce((sum, p) => sum + p.montant, 0) : 0;
        
      const loyerRestant = Math.max(0, totalLoyer - loyerPaye);
      const personnesActives = personnes.length;
      
      // Mettre √† jour les statistiques
      document.getElementById('totalLoyer').textContent = totalLoyer;
      document.getElementById('loyerPaye').textContent = loyerPaye;
      document.getElementById('loyerRestant').textContent = loyerRestant;
      document.getElementById('personnesLoyer').textContent = personnesActives;
      
      // Mettre √† jour les d√©penses impr√©vues
      // CORRECTION : V√©rifier si depensesImprevues existe et est un tableau
      const totalDepenses = Array.isArray(loyerData.depensesImprevues) ? 
        loyerData.depensesImprevues.reduce((sum, d) => sum + d.montant, 0) : 0;
        
      const partParPersonne = personnesActives > 0 ? Math.round(totalDepenses / personnesActives) : 0;
      
      document.getElementById('totalDepensesImprevues').textContent = totalDepenses;
      document.getElementById('partParPersonne').textContent = partParPersonne;
      
      // Afficher les paiements du loyer
      const peopleList = document.getElementById('rentPeopleList');
      peopleList.innerHTML = '';
      
      personnes.forEach(personne => {
        // CORRECTION : V√©rifier si paiements existe et est un tableau
        const paiementsPersonne = Array.isArray(loyerData.paiements) ? 
          loyerData.paiements.filter(p => p.personneId === personne.id) : [];
          
        const totalPaye = paiementsPersonne.reduce((sum, p) => sum + p.montant, 0);
        
        let paiementsHtml = '';
        if (paiementsPersonne.length > 0) {
          paiementsHtml = `
            <div style="margin-top: 10px; padding-left: 20px;">
              <h4 style="margin-bottom: 10px; color: #2d3748;">Paiements:</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
          `;
          
          paiementsPersonne.forEach(paiement => {
            paiementsHtml += `
              <div style="padding: 10px; background: #f7fafc; border-radius: 8px;">
                <div style="font-weight: 600;">${paiement.montant} DH</div>
                <div style="font-size: 0.85rem; color: #718096;">${new Date(paiement.date).toLocaleDateString('fr-FR')}</div>
                <button class="btn btn-danger" style="margin-top: 10px; padding: 5px 10px; font-size: 0.9rem;" 
                        onclick="deleteRentPayment(${paiement.id})">Supprimer</button>
              </div>
            `;
          });
          
          paiementsHtml += `
              </div>
            </div>
          `;
        }
        
        peopleList.innerHTML += `
          <div class="person-rent">
            <div class="person-rent-header">
              <h3>${personne.nom}</h3>
              <div class="rent-status ${totalPaye >= totalLoyer / personnesActives ? 'status-paid' : 'status-unpaid'}">
                ${totalPaye >= totalLoyer / personnesActives ? 'Solde positif' : 'Doit payer'}
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
              <div style="padding: 8px; background: white; border-radius: 5px;">
                <div style="font-size: 0.8rem; color: #718096;">Loyer pay√©</div>
                <div style="font-weight: 600; color: #4299e1;">${totalPaye} DH</div>
              </div>
              <div style="padding: 8px; background: white; border-radius: 5px;">
                <div style="font-size: 0.8rem; color: #718096;">Part attendue</div>
                <div style="font-weight: 600; color: #c53030;">${Math.round(totalLoyer / personnesActives)} DH</div>
              </div>
            </div>
            ${paiementsHtml}
          </div>
        `;
      });
      
      // Afficher les d√©penses
      const expensesList = document.getElementById('expensesList');
      expensesList.innerHTML = '';
      
      // CORRECTION : V√©rifier si depensesImprevues existe et est un tableau
      if (!Array.isArray(loyerData.depensesImprevues) || loyerData.depensesImprevues.length === 0) {
        expensesList.innerHTML = `
          <div class="empty-state" style="padding: 20px 0;">
            <div class="empty-icon">üßæ</div>
            <h3>Aucune d√©pense impr√©vue</h3>
            <p>Ajoutez des d√©penses impr√©vues pour suivre les co√ªts suppl√©mentaires.</p>
          </div>
        `;
      } else {
        loyerData.depensesImprevues.forEach(depense => {
          expensesList.innerHTML += `
            <div class="expense-item">
              <div class="expense-details">
                <div class="expense-title">${depense.nom}</div>
                <div class="expense-date">${new Date(depense.date).toLocaleDateString('fr-FR')}</div>
              </div>
              <div class="expense-amount">${depense.montant} DH</div>
              <div class="expense-actions">
                <button class="btn btn-danger" onclick="deleteExpense(${depense.id})">Supprimer</button>
              </div>
            </div>
          `;
        });
      }
      
      // Mettre √† jour le r√©sum√© des paiements
      mettreAJourResumePaiements();
    }

        // Mettre √† jour le r√©sum√© des paiements
    function mettreAJourResumePaiements() {
      // Calculer les totaux - SEULEMENT LOYER ET DEPENSES
      // CORRECTION : V√©rifier si paiements existe et est un tableau
      const totalLoyerPaye = Array.isArray(loyerData.paiements) ? 
        loyerData.paiements.reduce((sum, p) => sum + p.montant, 0) : 0;
        
      // CORRECTION : V√©rifier si depensesImprevues existe et est un tableau
      const totalDepenses = Array.isArray(loyerData.depensesImprevues) ? 
        loyerData.depensesImprevues.reduce((sum, d) => sum + d.montant, 0) : 0;
        
      const partParPersonne = personnes.length > 0 ? Math.round(totalDepenses / personnes.length) : 0;
      
      // Mettre √† jour les statistiques
      document.getElementById('totalPayeMois').textContent = totalLoyerPaye;
      document.getElementById('totalDepensesCalculees').textContent = totalDepenses;
      
      // Calculer le solde global
      const soldeGlobal = totalLoyerPaye - totalDepenses;
      document.getElementById('soldeGlobal').textContent = soldeGlobal;
      
      // Afficher le r√©sum√© par personne
      const summaryList = document.getElementById('paymentSummaryList');
      summaryList.innerHTML = '';
      
      personnes.forEach(personne => {
        // Calculate how much this person paid for rent
        // CORRECTION : V√©rifier si paiements existe et est un tableau
        const loyerPaye = Array.isArray(loyerData.paiements) ? 
          loyerData.paiements
            .filter(p => p.personneId === personne.id)
            .reduce((sum, p) => sum + p.montant, 0) : 0;
        
        // Calculate the person's share of expenses
        const solde = loyerPaye - partParPersonne;
        
        const html = `
          <div style="background: #f7fafc; padding: 15px; border-radius: 10px;">
            <h4 style="margin-bottom: 10px; color: #2d3748;">${personne.nom}</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="padding: 8px; background: white; border-radius: 5px;">
                <div style="font-size: 0.8rem; color: #718096;">Loyer pay√©</div>
                <div style="font-weight: 600;">${loyerPaye} DH</div>
              </div>
              <div style="padding: 8px; background: white; border-radius: 5px;">
                <div style="font-size: 0.8rem; color: #718096;">Part d√©penses</div>
                <div style="font-weight: 600;">${partParPersonne} DH</div>
              </div>
            </div>
            <div style="margin-top: 10px; padding: 8px; background: ${solde >= 0 ? '#f0fff4' : '#fff5f5'}; border-radius: 8px; text-align: center; font-weight: 600; color: ${solde >= 0 ? '#2f855a' : '#c53030'};">
              Solde: ${solde.toFixed(2)} DH
            </div>
          </div>
        `;
        
        summaryList.innerHTML += html;
      });
    }

    // Ouvrir la modal du rapport
    function genererRapport() {
      // Calculer les totaux
      const totalLoyerPaye = loyerData.paiements.reduce((sum, p) => sum + p.montant, 0);
      const totalDepenses = loyerData.depensesImprevues.reduce((sum, d) => sum + d.montant, 0);
      const partParPersonne = personnes.length > 0 ? Math.round(totalDepenses / personnes.length) : 0;
      
      // Mettre √† jour le rapport
      document.getElementById('reportTotalLoyer').textContent = `${loyerData.total} DH`;
      document.getElementById('reportDepensesImprevues').textContent = `${totalDepenses} DH`;
      document.getElementById('reportLoyerPaye').textContent = `${totalLoyerPaye} DH`;
      document.getElementById('reportTotalAPayer').textContent = `${loyerData.total / personnes.length} DH`;
      document.getElementById('reportSoldeGlobal').textContent = `${(totalLoyerPaye - totalDepenses).toFixed(2)} DH`;
      
      // D√©tail par personne
      const reportDetails = document.getElementById('reportPeopleDetails');
      reportDetails.innerHTML = '';
      
      personnes.forEach(personne => {
        const loyerPaye = loyerData.paiements
          .filter(p => p.personneId === personne.id)
          .reduce((sum, p) => sum + p.montant, 0);
        
        const solde = loyerPaye - partParPersonne;
        
        const html = `
          <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; color: #2d3748;">${personne.nom}</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="padding: 8px; background: white; border-radius: 5px;">
                <div style="font-size: 0.8rem; color: #718096;">Loyer pay√©</div>
                <div style="font-weight: 600;">${loyerPaye} DH</div>
              </div>
              <div style="padding: 8px; background: white; border-radius: 5px;">
                <div style="font-size: 0.8rem; color: #718096;">Part d√©penses</div>
                <div style="font-weight: 600;">${partParPersonne} DH</div>
              </div>
            </div>
            <div style="margin-top: 10px; padding: 8px; background: ${solde >= 0 ? '#f0fff4' : '#fff5f5'}; border-radius: 8px; text-align: center; font-weight: 600; color: ${solde >= 0 ? '#2f855a' : '#c53030'};">
              Solde: ${solde.toFixed(2)} DH
            </div>
          </div>
        `;
        
        reportDetails.innerHTML += html;
      });
      
      // Afficher la modal
      document.getElementById('reportModal').style.display = 'flex';
    }

    // Imprimer le rapport
    function printReport() {
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Rapport de gestion</title>');
      printWindow.document.write('<style>body { font-family: Arial, sans-serif; padding: 20px; } .report-section { margin-bottom: 20px; } h2 { color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px; } .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; } .summary-item { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; } .person-summary { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; }</style>');
      printWindow.document.write('</head><body >');
      printWindow.document.write(document.getElementById('reportContent').innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }
  </script>
</body>
</html>

